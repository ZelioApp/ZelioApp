<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ZELIO - Solution Devis √âlectricit√©</title>
<!-- Remplacement de html2pdf.js par PDFMake -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<style>
:root {
  --primary: #4f46e5;
  --bg: #f1f5f9;
  --card: #ffffff;
  --text: #1f2937;
  --accent: #10b981;
}
body.dark {
  --primary: #6366f1;
  --bg: #18181b;
  --card: #23232a;
  --text: #f1f5f9;
  --accent: #22d3ee;
}
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  padding-bottom: 200px;
  transition: background 0.2s, color 0.2s;
}
.header-brand {
  background: var(--card);
  padding: 1.5rem;
  text-align: center;
  border-bottom: 1px solid #e2e8f0;
  position: relative;
}
.logo-text {
  font-size: 2.5rem;
  font-weight: 900;
  color: var(--primary);
  letter-spacing: -2px;
  margin: 0;
}
.logo-subtitle {
  font-size: 0.8rem;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-top: -5px;
}
#logo-preview {
  max-width: 80px; max-height: 60px; display: block; margin: 0 auto 5px auto;
}
#dark-toggle {
  position: absolute; right: 20px; top: 20px; background: var(--bg); border: 1px solid #e2e8f0; border-radius: 50%; width: 38px; height: 38px; cursor: pointer; font-size: 1.3rem; color: var(--primary);
}

/* ----------- NAV TABS (ONGLETS) ----------- */
.nav-tabs {
  display: flex; 
  justify-content: center; 
  gap: 10px; 
  background: var(--card); 
  padding: 0.8rem; 
  position: sticky; 
  top: 0; 
  z-index: 1000; 
  box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
  flex-wrap: wrap;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.tab-btn {
  padding: 0.7rem 1.1rem; 
  border: none; 
  background: #e2e8f0; 
  border-radius: 8px; 
  cursor: pointer; 
  font-weight: bold; 
  font-size: 0.9rem; 
  flex: 1 1 120px; 
  min-width: 90px; 
  max-width: 180px;
  white-space: nowrap;
  transition: background 0.2s, color 0.2s;
}
.tab-btn.active { background: var(--primary); color: white; }
.container { max-width: 1100px; margin: auto; padding: 1rem; }
.page { display: none; }
.page.active { display: block; }
.form-section {
  background: var(--card); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #e2e8f0;
}
.form-section h2 { margin-top: 0; font-size: 1.1rem; color: var(--primary); margin-bottom: 1rem; }
.grid-forms { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; }
.form-group label { display: block; font-size: 0.75rem; font-weight: bold; margin-bottom: 4px; color: #64748b; }
input.full-width, textarea.full-width, select.full-width { width: 100%; padding: 0.7rem; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 0.9rem; }
textarea.full-width { resize: vertical; }
.accordion-controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 1rem; }
.btn-small { padding: 6px 12px; font-size: 0.75rem; background: #cbd5e1; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
.btn-danger { background: #fee2e2; color: #ef4444; }
.accordion-item { background: var(--card); border-radius: 12px; margin-bottom: 0.6rem; overflow: hidden; border: 1px solid #e2e8f0; }
.accordion-header { width: 100%; padding: 1.1rem; background: var(--card); border: none; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: bold; text-align: left; }
.accordion-header::after { content: '+'; color: var(--primary); font-size: 1.2rem; }
.accordion-item.open .accordion-header { border-bottom: 1px solid #f1f5f9; color: var(--primary); }
.accordion-item.open .accordion-header::after { content: '-'; }
.accordion-content { display: none; padding: 1rem; background: #fafafa; }
.accordion-item.open .accordion-content { display: block; }
.grid-items { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 0.7rem; }
.item { display: flex; align-items: center; justify-content: space-between; background: var(--card); padding: 0.6rem 0.9rem; border-radius: 8px; border: 1px solid #e2e8f0; position:relative;}
.item label { font-size: 0.85rem; flex: 1; margin-right: 10px; }
select, input[type="number"] { width: 70px; padding: 0.4rem; border-radius: 6px; border: 1px solid #cbd5e1; }
.footer { position: fixed; bottom: 0; width: 100%; background: var(--card); padding: 1rem; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); z-index: 1001; flex-wrap:wrap;}
.total-amount { font-size: 1.5rem; font-weight: 800; color: var(--primary); }
.btn-generate { background: var(--primary); color: white; padding: 0.9rem 2rem; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin: 0 5px;}
.footer-info { font-size: 1rem; color: #64748b; margin: 0 10px;}
.toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 12px 24px; border-radius: 8px; font-size: 1rem; z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.15);}
#signature-pad { background: #fff; border: 1px solid #cbd5e1; border-radius: 8px; }
#signature-pad.dark { background: #23232a; }
#faq-content { font-size: 0.95em; color: #64748b; }
#faq-content h3 { color: var(--primary); margin-top: 1.2em; }
#faq-content ul { margin: 0 0 1em 1.2em; }

/* ----------- AM√âLIORATION RESPONSIVE MOBILE ----------- */
@media (max-width: 900px) {
  .nav-tabs {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    flex-wrap: nowrap;
    gap: 5px;
  }
  .tab-btn {
    min-width: 110px;
    max-width: 200px;
    font-size: 0.95rem;
    flex: 0 0 auto;
  }
}
@media (max-width: 700px) {
  .footer { flex-direction: column; gap: 10px; }
  .btn-generate { width: 100%; }
  .nav-tabs { 
    flex-wrap: nowrap; 
    gap: 5px; 
    overflow-x: auto; 
    -webkit-overflow-scrolling: touch; 
    justify-content: flex-start;
  }
  .tab-btn { 
    min-width: 100px; 
    font-size: 0.85rem; 
    padding: 0.6rem 0.5rem; 
    flex: 0 0 auto;
    white-space: nowrap;
  }
  .container { padding: 0.5rem; }
  .form-section { padding: 1rem; }
  .grid-forms { grid-template-columns: 1fr; gap: 0.5rem; }
  .grid-items { grid-template-columns: 1fr; gap: 0.5rem; }
  .item { flex-direction: column; align-items: flex-start; gap: 6px; }
  .item label { margin-right: 0; }
  .footer-info { font-size: 0.95rem; }
  #logo-preview { max-width: 60px; max-height: 40px; }
  .header-brand { padding: 1rem; }
}
@media (max-width: 500px) {
  .nav-tabs { 
    flex-direction: row; 
    flex-wrap: nowrap; 
    overflow-x: auto; 
    -webkit-overflow-scrolling: touch; 
    align-items: stretch; 
    gap: 3px;
    padding: 0.5rem 0.2rem;
  }
  .tab-btn { 
    width: auto; 
    min-width: 90px; 
    max-width: 150px; 
    font-size: 0.8rem; 
    padding: 0.5rem 0.3rem; 
    flex: 0 0 auto;
    white-space: nowrap;
  }
  .container { padding: 0.2rem; }
  .form-section { padding: 0.7rem; }
  .footer { padding: 0.5rem; }
  .footer-info { font-size: 0.9rem; }
  .logo-text { font-size: 1.5rem; }
  .logo-subtitle { font-size: 0.7rem; }
  #logo-preview { max-width: 40px; max-height: 30px; }
  .item { font-size: 0.95em; }
  .accordion-header { font-size: 1em; padding: 0.7rem; }
}
@media (max-width: 400px) {
  .form-section { padding: 0.4rem; }
  .footer { padding: 0.2rem; }
  .footer-info { font-size: 0.8rem; }
  .logo-text { font-size: 1.1rem; }
  .logo-subtitle { font-size: 0.6rem; }
  #logo-preview { max-width: 30px; max-height: 20px; }
}
/* ----------- FIN AM√âLIORATION RESPONSIVE MOBILE ----------- */

/* ----------- NAV TABS MOBILE FIXED BOTTOM ----------- */
@media (max-width: 700px) {
  .nav-tabs {
    position: fixed;
    bottom: 0;
    top: auto;
    left: 0;
    right: 0;
    width: 100vw;
    background: var(--card);
    box-shadow: 0 -2px 10px rgba(0,0,0,0.07);
    z-index: 2002;
    padding-bottom: env(safe-area-inset-bottom, 0);
    border-top: 1px solid #e2e8f0;
  }
  body {
    padding-bottom: 260px;
  }
  .footer {
    bottom: 56px;
  }
}
@media (max-width: 500px) {
  .nav-tabs {
    padding: 0.2rem 0.1rem 0.2rem 0.1rem;
    min-height: 48px;
  }
  .footer {
    bottom: 56px;
  }
  body {
    padding-bottom: 270px;
  }
}
/* ----------- FIN NAV TABS MOBILE FIXED BOTTOM ----------- */
</style>
</head>
<body>

<div class="header-brand">
    <img id="logo-preview" src="" alt="Logo" style="display:none;">
    <h1 class="logo-text">ZELIO ELEC</h1>
    <div class="logo-subtitle">Logiciel de Chiffrage Professionnel</div>
    <button id="dark-toggle" title="Mode sombre/clair" onclick="toggleDarkMode()">üåô</button>
</div>

<div class="nav-tabs" role="tablist">
  <button class="tab-btn active" onclick="showPage('config', event)" aria-selected="true" aria-controls="page-config">üìã Devis</button>
  <button class="tab-btn" onclick="showPage('prices', event)" aria-selected="false" aria-controls="page-prices">‚öôÔ∏è Param√®tres</button>
  <button class="tab-btn" onclick="showPage('clients', event)" aria-selected="false" aria-controls="page-clients">üë• Clients</button>
  <button class="tab-btn" onclick="showPage('export', event)" aria-selected="false" aria-controls="page-export">üíæ Sauvegarde</button>
  <button class="tab-btn" onclick="showPage('folders', event)" aria-selected="false" aria-controls="page-folders">üìÅ Dossiers</button>
  <button class="tab-btn" onclick="showPage('faq', event)" aria-selected="false" aria-controls="page-faq">‚ùì Aide</button>
</div>

<div class="container">
  <!-- PAGE DEVIS -->
  <div id="page-config" class="page active">
    <div class="form-section">
      <h2>üë§ Informations Client & Chantier</h2>
      <div class="grid-forms">
        <div class="form-group">
          <label>Client enregistr√©</label>
          <select id="client-select" class="full-width"></select>
        </div>
        <div class="form-group"><label>Nom du Client</label><input type="text" id="c-name" class="full-width" placeholder="Ex: Jean Dupont" required></div>
        <div class="form-group"><label>T√©l√©phone</label><input type="text" id="c-phone" class="full-width" placeholder="06 00 00 00 00" pattern="^0[1-9]([-. ]?[0-9]{2}){4}$"></div>
        <div class="form-group"><label>Email</label><input type="email" id="c-email" class="full-width" placeholder="client@email.com"></div>
        <div class="form-group"><label>Adresse de Facturation</label><input type="text" id="c-addr" class="full-width" placeholder="Adresse compl√®te"></div>
        <div class="form-group"><label>Adresse du Chantier</label><input type="text" id="c-site" class="full-width" placeholder="Si diff√©rente"></div>
        <div class="form-group"><label>Type de bien</label><input type="text" id="c-type" class="full-width" placeholder="Ex: Maison T4"></div>
        <div class="form-group" style="grid-column:1/-1;">
          <label>Notes du chantier</label>
          <textarea id="c-notes" class="full-width" placeholder="Ex : acc√®s difficile, pr√©sence d‚Äôanimaux, etc." style="min-height:60px;"></textarea>
        </div>
        <div class="form-group" style="grid-column:1/-1;">
          <label>Notes internes (non visibles sur le devis)</label>
          <textarea id="c-notes-internal" class="full-width" placeholder="Notes priv√©es, organisation, etc." style="min-height:40px;"></textarea>
        </div>
      </div>
      <button class="btn-small" onclick="saveClient()">üíæ Enregistrer ce client</button>
    </div>
    <div class="form-section">
      <h2>üì∏ Photos du Chantier</h2>
      <input type="file" id="site-photos" accept="image/*" multiple capture="environment" style="margin-bottom:10px;">
      <button class="btn-small" onclick="takePhoto()">üì∑ Prendre une photo</button>
      <video id="camera-stream" style="display:none; width:100%; max-width:300px; margin:10px 0;" autoplay></video>
      <button id="capture-btn" class="btn-small" style="display:none;">Capturer</button>
      <canvas id="photo-canvas" style="display:none;"></canvas>
      <div id="photo-preview" style="display:flex; gap:10px; flex-wrap:wrap;"></div>
    </div>
    <div class="form-section">
      <h2>‚úçÔ∏è Signature du client</h2>
      <canvas id="signature-pad" width="300" height="100"></canvas>
      <button class="btn-small" onclick="clearSignature()">Effacer</button>
    </div>
    <div class="form-section">
      <div class="grid-forms">
        <div class="form-group">
          <label>Statut du dossier</label>
          <select id="folder-status" class="full-width">
            <option value="Brouillon">Brouillon</option>
            <option value="Envoy√©">Envoy√©</option>
            <option value="Accept√©">Accept√©</option>
            <option value="Refus√©">Refus√©</option>
            <option value="Factur√©">Factur√©</option>
          </select>
        </div>
        <div class="form-group">
          <label>Remise (%)</label>
          <input type="number" id="discount" class="full-width" min="0" max="100" value="0">
        </div>
        <div class="form-group">
          <label>Acompte (‚Ç¨)</label>
          <input type="number" id="deposit" class="full-width" min="0" value="0">
        </div>
        <div class="form-group">
          <label>TVA (%)</label>
          <select id="tva-rate" class="full-width">
            <option value="20">20%</option>
            <option value="10">10%</option>
            <option value="5.5">5,5%</option>
            <option value="0">0%</option>
          </select>
        </div>
      </div>
    </div>
    <div class="accordion-controls">
        <button class="btn-small" onclick="toggleAll(true)">Tout ouvrir</button>
        <button class="btn-small" onclick="toggleAll(false)">Tout fermer</button>
        <button class="btn-small btn-danger" onclick="resetQuantities()">Vider le panier</button>
    </div>
    <div id="config-accordion"></div>
  </div>

  <!-- PAGE PRIX -->
  <div id="page-prices" class="page">
    <div class="form-section">
        <h2>üõ†Ô∏è Mes Informations Artisan</h2>
        <div class="grid-forms">
            <div class="form-group"><label>Nom Entreprise / Nom</label><input type="text" id="my-name" class="full-width"></div>
            <div class="form-group"><label>SIRET</label><input type="text" id="my-siret" class="full-width" pattern="^\d{14}$"></div>
            <div class="form-group"><label>Adresse Pro</label><input type="text" id="my-addr" class="full-width"></div>
            <div class="form-group"><label>Assurance D√©cennale</label><input type="text" id="my-ins" class="full-width"></div>
        </div>
        <div class="form-group" style="margin-top:1em;">
          <label>Logo de l'entreprise (affich√© sur les PDF)</label>
          <input type="file" id="logo-upload" accept="image/*">
        </div>
        <button class="btn-small btn-danger" style="margin-top:20px;" onclick="fullReset()">‚ö†Ô∏è R√©initialiser TOUTE la base de donn√©es</button>
    </div>
    <div class="form-section">
      <h2>‚ûï Ajouter un produit ou une cat√©gorie</h2>
      <div class="grid-forms">
        <div class="form-group">
          <label>Cat√©gorie</label>
          <div style="display:flex;gap:6px;flex-direction:row;">
            <select id="cat-select" class="full-width" style="flex:2;"></select>
            <input type="text" id="new-cat" class="full-width" placeholder="Nouvelle cat√©gorie" style="flex:3;">
          </div>
        </div>
        <div class="form-group">
          <label>Nom du produit</label>
          <input type="text" id="new-prod" class="full-width" placeholder="Nom du produit">
        </div>
        <div class="form-group">
          <label>Prix (‚Ç¨)</label>
          <input type="number" id="new-price" class="full-width" min="0" value="0">
        </div>
        <div class="form-group">
          <label>Temps (h)</label>
          <input type="number" id="new-time" class="full-width" min="0" step="0.01" value="0">
        </div>
        <div class="form-group">
          <label>Unit√©</label>
          <input type="text" id="new-unit" class="full-width" placeholder="u, m, h...">
        </div>
      </div>
      <button class="btn-small" onclick="addProduct()">Ajouter</button>
    </div>
    <div id="prices-accordion"></div>
  </div>

  <!-- PAGE CLIENTS -->
  <div id="page-clients" class="page">
    <div class="form-section">
      <h2>üë• Mes Clients Enregistr√©s</h2>
      <input type="text" id="search-client" class="full-width" placeholder="Recherche client...">
      <div id="clients-list"></div>
      <button class="btn-small" onclick="exportClientsCSV()">Exporter clients (CSV)</button>
    </div>
  </div>

  <!-- PAGE EXPORT -->
  <div id="page-export" class="page">
    <div class="form-section">
      <h2>üíæ Sauvegarde / Restauration</h2>
      <button class="btn-small" onclick="exportData()">Exporter la base (JSON)</button>
      <input type="file" id="import-file" accept=".json" style="margin-top:10px;">
      <button class="btn-small" onclick="exportFoldersCSV()">Exporter dossiers (CSV)</button>
      <button class="btn-small" onclick="exportProductsCSV()">Exporter produits (CSV)</button>
      <p style="font-size:0.9em; color:#64748b;">Exportez ou importez toutes vos donn√©es (produits, clients, photos, dossiers, etc.)</p>
    </div>
  </div>

  <!-- PAGE DOSSIERS -->
  <div id="page-folders" class="page">
    <div class="form-section">
      <h2>üìÅ Dossiers Clients</h2>
      <input type="text" id="search-folder" class="full-width" placeholder="Recherche dossier...">
      <div id="folders-list"></div>
      <button class="btn-small" onclick="exportFoldersCSV()">Exporter dossiers (CSV)</button>
    </div>
  </div>

  <!-- PAGE FAQ -->
  <div id="page-faq" class="page">
    <div class="form-section">
      <h2>‚ùì Aide & FAQ</h2>
      <div id="faq-content">
        <h3>Comment ajouter un produit ou une cat√©gorie ?</h3>
        <ul>
          <li>Allez dans l‚Äôonglet <b>Param√®tres</b> puis remplissez le formulaire ‚ÄúAjouter un produit ou une cat√©gorie‚Äù.</li>
        </ul>
        <h3>Comment changer le logo de l‚Äôentreprise ?</h3>
        <ul>
          <li>Dans <b>Param√®tres</b>, importez votre logo (format PNG/JPG, max 200ko recommand√©).</li>
        </ul>
        <h3>Comment utiliser la signature √©lectronique ?</h3>
        <ul>
          <li>Dans l‚Äôonglet <b>Devis</b>, signez sur le cadre pr√©vu. La signature sera int√©gr√©e dans le PDF.</li>
        </ul>
        <h3>Comment appliquer une remise ou un acompte ?</h3>
        <ul>
          <li>Dans <b>Devis</b>, renseignez le pourcentage de remise ou le montant d‚Äôacompte.</li>
        </ul>
        <h3>Comment changer le taux de TVA ?</h3>
        <ul>
          <li>Dans <b>Devis</b>, choisissez le taux de TVA souhait√©.</li>
        </ul>
        <h3>Comment filtrer ou rechercher un client/dossier ?</h3>
        <ul>
          <li>Utilisez le champ de recherche dans l‚Äôonglet <b>Clients</b> ou <b>Dossiers</b>.</li>
        </ul>
        <h3>Comment activer le mode sombre ?</h3>
        <ul>
          <li>Cliquez sur l‚Äôic√¥ne üåô en haut √† droite.</li>
        </ul>
        <h3>Comment exporter mes donn√©es ?</h3>
        <ul>
          <li>Dans <b>Sauvegarde</b>, exportez en JSON ou CSV.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="footer">
  <div class="footer-info">Total HT : <span class="total-amount"><span id="grand-total">0</span>‚Ç¨</span></div>
  <div class="footer-info">Temps estim√© : <span id="grand-time">0</span> h</div>
  <button class="btn-generate" onclick="generatePDF()">G√âN√âRER LE DEVIS</button>
  <button class="btn-generate" style="background:#10b981;" onclick="generateReport()">G√âN√âRER LE RAPPORT</button>
</div>

<div id="toast" class="toast" style="display:none;"></div>

<script>
// --- TOAST FEEDBACK ---
function showToast(msg, color="#10b981") {
  const t = document.getElementById('toast');
  t.innerText = msg;
  t.style.background = color;
  t.style.display = "block";
  setTimeout(()=>{ t.style.display="none"; }, 2200);
}

// --- MODE SOMBRE ---
function toggleDarkMode() {
  document.body.classList.toggle('dark');
  localStorage.setItem('zelio_dark', document.body.classList.contains('dark') ? "1" : "0");
  document.getElementById('signature-pad').className = document.body.classList.contains('dark') ? "dark" : "";
}
if(localStorage.getItem('zelio_dark')==="1") document.body.classList.add('dark');

// --- LOGO ENTREPRISE ---
let logoData = localStorage.getItem('zelio_logo') || "";
function updateLogoPreview() {
  const img = document.getElementById('logo-preview');
  if(logoData) { img.src = logoData; img.style.display = "block"; }
  else { img.style.display = "none"; }
}
updateLogoPreview();
document.getElementById('logo-upload').addEventListener('change', function(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    logoData = evt.target.result;
    localStorage.setItem('zelio_logo', logoData);
    updateLogoPreview();
    showToast("Logo enregistr√© !");
  };
  reader.readAsDataURL(file);
});

// --- BASE DE DONN√âES AVEC UNIT√âS ---
const defaultDatabase = {
  "‚ö° √âclairage Int√©rieur": {
    "Spot encastr√© LED": { price: 45, time: 0.5, unit: "u" },
    "Spot en saillie": { price: 50, time: 0.5, unit: "u" },
    "Spot orientable": { price: 55, time: 0.5, unit: "u" },
    "Plafonnier": { price: 65, time: 0.7, unit: "u" },
    "Suspension": { price: 75, time: 0.7, unit: "u" },
    "Applique murale": { price: 55, time: 0.5, unit: "u" },
    "R√©glette LED garage": { price: 45, time: 0.4, unit: "u" },
    "Ruban LED (ml)": { price: 25, time: 0.1, unit: "m" },
    "Profil√© Alu pour LED": { price: 30, time: 0.1, unit: "m" },
    "Variateur de lumi√®re": { price: 50, time: 0.2, unit: "u" },
    "D√©tecteur de pr√©sence": { price: 95, time: 0.3, unit: "u" },
    "Transformateur LED": { price: 35, time: 0.2, unit: "u" }
  },
  "üîå Prises & Interrupteurs": {
    "Prise de courant 16A": { price: 35, time: 0.2, unit: "u" },
    "Prise √©tanche IP55": { price: 45, time: 0.25, unit: "u" },
    "Prise USB (A+C)": { price: 60, time: 0.25, unit: "u" },
    "Prise RJ45 Cat6": { price: 65, time: 0.3, unit: "u" },
    "Prise TV / Satellite": { price: 45, time: 0.2, unit: "u" },
    "Interrupteur simple": { price: 25, time: 0.15, unit: "u" },
    "Va-et-vient": { price: 35, time: 0.2, unit: "u" },
    "Bouton poussoir": { price: 32, time: 0.15, unit: "u" },
    "Double va-et-vient": { price: 45, time: 0.25, unit: "u" },
    "Sortie de c√¢ble": { price: 20, time: 0.1, unit: "u" }
  },
  "üßØ C√¢blage & Cheminement": {
    "C√¢ble 3G1.5 (ml)": { price: 3, time: 0.01, unit: "m" },
    "C√¢ble 3G2.5 (ml)": { price: 4, time: 0.01, unit: "m" },
    "C√¢ble RJ45 (ml)": { price: 4.5, time: 0.01, unit: "m" },
    "Gaine ICTA √ò20 (ml)": { price: 2.5, time: 0.01, unit: "m" },
    "Gaine ICTA √ò25 (ml)": { price: 3, time: 0.01, unit: "m" },
    "Goulotte 20x12 (ml)": { price: 12, time: 0.02, unit: "m" },
    "Goulotte 40x20 (ml)": { price: 18, time: 0.02, unit: "m" },
    "Bo√Æte de d√©rivation": { price: 15, time: 0.1, unit: "u" }
  },
  "üì¶ Tableaux & Protections": {
    "Tableau √©lectrique nu": { price: 150, time: 1.5, unit: "u" },
    "Disjoncteur 10A/16A": { price: 25, time: 0.15, unit: "u" },
    "Disjoncteur 20A/32A": { price: 35, time: 0.15, unit: "u" },
    "Interrupteur Diff√©rentiel 40A": { price: 95, time: 0.2, unit: "u" },
    "Interrupteur Diff√©rentiel 63A": { price: 130, time: 0.2, unit: "u" },
    "Disjoncteur diff√©rentiel": { price: 115, time: 0.2, unit: "u" },
    "Parafoudre": { price: 170, time: 0.3, unit: "u" },
    "Contacteur Jour/Nuit": { price: 85, time: 0.2, unit: "u" },
    "T√©l√©rupteur": { price: 70, time: 0.2, unit: "u" },
    "Bornier de terre": { price: 15, time: 0.05, unit: "u" }
  },
  "üè† Domotique & Connect√©": {
    "Micromodule volet roulant": { price: 85, time: 0.3, unit: "u" },
    "Micromodule √©clairage": { price: 80, time: 0.3, unit: "u" },
    "Pack d√©marrage connect√©": { price: 180, time: 0.5, unit: "u" },
    "Thermostat connect√©": { price: 230, time: 0.5, unit: "u" },
    "Capteur ouverture fen√™tre": { price: 55, time: 0.1, unit: "u" },
    "Passerelle Wifi/Zigbee": { price: 110, time: 0.2, unit: "u" }
  },
  "üö™ Ouvertures Automatis√©es": {
    "Moteur volet roulant": { price: 290, time: 1, unit: "u" },
    "Motorisation portail battant": { price: 980, time: 3, unit: "u" },
    "Motorisation portail coulissant": { price: 1100, time: 3, unit: "u" },
    "Cellule de s√©curit√©": { price: 90, time: 0.2, unit: "u" },
    "Feu clignotant orange": { price: 75, time: 0.1, unit: "u" },
    "Antenne d√©port√©e": { price: 45, time: 0.1, unit: "u" }
  },
  "üî• Chauffage & Ventilation": {
    "Radiateur √† inertie 1000W": { price: 390, time: 1, unit: "u" },
    "Radiateur √† inertie 2000W": { price: 550, time: 1.2, unit: "u" },
    "S√®che-serviette": { price: 450, time: 1, unit: "u" },
    "VMC simple flux": { price: 550, time: 2, unit: "u" },
    "VMC double flux": { price: 2900, time: 6, unit: "u" },
    "Extracteur ponctuel": { price: 130, time: 0.3, unit: "u" },
    "Bouche d'extraction": { price: 35, time: 0.05, unit: "u" }
  },
  "üîî S√©curit√© & Communication": {
    "Centrale Alarme": { price: 550, time: 1, unit: "u" },
    "Sir√®ne ext√©rieure": { price: 180, time: 0.2, unit: "u" },
    "D√©tecteur fum√©e": { price: 45, time: 0.1, unit: "u" },
    "Visiophone connect√©": { price: 490, time: 1, unit: "u" },
    "Interphone audio": { price: 260, time: 0.5, unit: "u" },
    "Cam√©ra IP ext√©rieure": { price: 350, time: 0.5, unit: "u" },
    "Baie de brassage": { price: 420, time: 1, unit: "u" }
  },
  "üß∞ Prestations & Main d'≈ìuvre": {
    "Heure de main d'≈ìuvre": { price: 55, time: 1, unit: "h" },
    "Forfait d√©placement": { price: 50, time: 0, unit: "u" },
    "Mise en conformit√© tableau": { price: 850, time: 3, unit: "u" },
    "Saign√©e dans b√©ton (ml)": { price: 40, time: 0.1, unit: "m" },
    "Recherche de panne": { price: 90, time: 1, unit: "u" },
    "Consuel (frais + dossier)": { price: 250, time: 0, unit: "u" }
  }
};
let database = JSON.parse(localStorage.getItem('zelio_full_v6')) || defaultDatabase;
let photos = JSON.parse(localStorage.getItem('zelio_photos')) || [];
let clients = JSON.parse(localStorage.getItem('zelio_clients')) || [];
let folders = JSON.parse(localStorage.getItem('zelio_folders')) || [];
let formData = JSON.parse(localStorage.getItem('zelio_formdata')) || {};
let signatureData = localStorage.getItem('zelio_signature') || "";

// --- NAVIGATION ---
function showPage(id, event) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  if(event) event.currentTarget.classList.add('active');
  if(id === 'clients') renderClients();
  if(id === 'export') document.getElementById('import-file').value = '';
  if(id === 'folders') renderFolders();
  if(id === 'faq') {} // rien
}

// --- ACCORD√âON ---
function toggleAccordion(header) { header.parentElement.classList.toggle('open'); }
function toggleAll(show) { document.querySelectorAll('.accordion-item').forEach(item => show ? item.classList.add('open') : item.classList.remove('open')); }
function resetQuantities() { if(confirm("R√©initialiser toutes les quantit√©s √† 0 ?")) { document.querySelectorAll('.qty-in').forEach(s => s.value = 0); calculate(); saveFormData(); showToast("Panier vid√© !"); } }
function fullReset() { if(confirm("Voulez-vous supprimer tous vos prix personnalis√©s et revenir √† la liste d'origine ?")) { localStorage.clear(); location.reload(); } }

// --- CLIENTS ---
function saveClient() {
  const c = {
    name: document.getElementById('c-name').value.trim(),
    phone: document.getElementById('c-phone').value.trim(),
    email: document.getElementById('c-email').value.trim(),
    addr: document.getElementById('c-addr').value.trim(),
    site: document.getElementById('c-site').value.trim(),
    type: document.getElementById('c-type').value.trim(),
    notes: document.getElementById('c-notes').value.trim(),
    notes_internal: document.getElementById('c-notes-internal').value.trim()
  };
  if(!c.name) return showToast("Nom du client obligatoire !", "#ef4444");
  if(c.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(c.email)) return showToast("Email invalide !", "#ef4444");
  if(c.phone && !/^0[1-9]([-. ]?[0-9]{2}){4}$/.test(c.phone)) return showToast("T√©l√©phone invalide !", "#ef4444");
  if(clients.find(cl => cl.name === c.name)) {
    if(!confirm("Ce client existe d√©j√†. √âcraser ?")) return;
    clients = clients.filter(cl => cl.name !== c.name);
  }
  clients.push(c);
  localStorage.setItem('zelio_clients', JSON.stringify(clients));
  renderClientSelect();
  showToast("Client enregistr√© !");
}
function renderClientSelect() {
  const sel = document.getElementById('client-select');
  sel.innerHTML = `<option value="">-- Nouveau client --</option>`;
  clients.forEach((c,i) => {
    sel.innerHTML += `<option value="${i}">${c.name}</option>`;
  });
}
document.getElementById('client-select').addEventListener('change', function() {
  const idx = this.value;
  if(idx === "") {
    document.getElementById('c-name').value = "";
    document.getElementById('c-phone').value = "";
    document.getElementById('c-email').value = "";
    document.getElementById('c-addr').value = "";
    document.getElementById('c-site').value = "";
    document.getElementById('c-type').value = "";
    document.getElementById('c-notes').value = "";
    document.getElementById('c-notes-internal').value = "";
    saveFormData();
    return;
  }
  const c = clients[idx];
  document.getElementById('c-name').value = c.name;
  document.getElementById('c-phone').value = c.phone;
  document.getElementById('c-email').value = c.email;
  document.getElementById('c-addr').value = c.addr;
  document.getElementById('c-site').value = c.site;
  document.getElementById('c-type').value = c.type;
  document.getElementById('c-notes').value = c.notes;
  document.getElementById('c-notes-internal').value = c.notes_internal || "";
  saveFormData();
});
function renderClients() {
  const clDiv = document.getElementById('clients-list');
  let filter = document.getElementById('search-client').value.toLowerCase();
  clDiv.innerHTML = '';
  let filtered = clients.filter(c => c.name.toLowerCase().includes(filter) || c.addr.toLowerCase().includes(filter) || c.email.toLowerCase().includes(filter));
  if(!filtered.length) { clDiv.innerHTML = "<p style='color:#888;'>Aucun client enregistr√©.</p>"; return; }
  filtered.forEach((c, i) => {
    clDiv.innerHTML += `
      <div class="item">
        <label><b>${c.name}</b> - ${c.phone} - ${c.email}</label>
        <button class="btn-small btn-danger" onclick="deleteClient(${i})">Supprimer</button>
      </div>
    `;
  });
}
function deleteClient(idx) {
  if(confirm("Supprimer ce client ?")) {
    clients.splice(idx,1);
    localStorage.setItem('zelio_clients', JSON.stringify(clients));
    renderClients();
    renderClientSelect();
    showToast("Client supprim√© !");
  }
}
document.getElementById('search-client').addEventListener('input', renderClients);

// --- PHOTOS (compression avant stockage, max 10 photos) ---
document.getElementById('site-photos').addEventListener('change', function(e) {
  const files = Array.from(e.target.files);
  if(photos.length + files.length > 10) {
    showToast("Maximum 10 photos par dossier !", "#ef4444");
    return;
  }
  files.forEach(file => compressAndStorePhoto(file));
  e.target.value = '';
});
function compressAndStorePhoto(file) {
  const reader = new FileReader();
  reader.onload = function(evt) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      const maxW = 800;
      const scale = Math.min(1, maxW / img.width);
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
      photos.push(dataUrl);
      localStorage.setItem('zelio_photos', JSON.stringify(photos));
      showPhotoPreview();
    };
    img.src = evt.target.result;
  };
  reader.readAsDataURL(file);
}
function showPhotoPreview() {
  const preview = document.getElementById('photo-preview');
  preview.innerHTML = '';
  photos.forEach((src, idx) => {
    preview.innerHTML += `
      <div style="position:relative;">
        <img src="${src}" style="width:90px; height:90px; object-fit:cover; border-radius:8px; border:1px solid #ccc;">
        <button onclick="removePhoto(${idx})" style="position:absolute;top:2px;right:2px;background:#ef4444;color:white;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer;">√ó</button>
      </div>
    `;
  });
}
function removePhoto(idx) {
  photos.splice(idx, 1);
  localStorage.setItem('zelio_photos', JSON.stringify(photos));
  showPhotoPreview();
  showToast("Photo supprim√©e !");
}
showPhotoPreview();

// --- PRENDRE UNE PHOTO DIRECTEMENT ---
function takePhoto() {
  const video = document.getElementById('camera-stream');
  const captureBtn = document.getElementById('capture-btn');
  video.style.display = 'block';
  captureBtn.style.display = 'inline-block';
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => {
      video.srcObject = stream;
      captureBtn.onclick = function() {
        const canvas = document.getElementById('photo-canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
        if(photos.length >= 10) {
          showToast("Maximum 10 photos par dossier !", "#ef4444");
        } else {
          photos.push(dataUrl);
          localStorage.setItem('zelio_photos', JSON.stringify(photos));
          showPhotoPreview();
          showToast("Photo ajout√©e !");
        }
        stream.getTracks().forEach(track => track.stop());
        video.style.display = 'none';
        captureBtn.style.display = 'none';
      };
    })
    .catch(() => {
      showToast("Impossible d'acc√©der √† la cam√©ra.", "#ef4444");
      video.style.display = 'none';
      captureBtn.style.display = 'none';
    });
}

// --- SIGNATURE √âLECTRONIQUE ---
const sigPad = document.getElementById('signature-pad');
const sigCtx = sigPad.getContext('2d');
let drawing = false;
sigPad.addEventListener('mousedown', e => { drawing = true; sigCtx.beginPath(); sigCtx.moveTo(e.offsetX, e.offsetY); });
sigPad.addEventListener('mousemove', e => { if(drawing) { sigCtx.lineTo(e.offsetX, e.offsetY); sigCtx.stroke(); } });
sigPad.addEventListener('mouseup', () => { drawing = false; saveSignature(); });
sigPad.addEventListener('mouseleave', () => { drawing = false; });
sigPad.addEventListener('touchstart', function(e){ e.preventDefault(); drawing = true; const r = sigPad.getBoundingClientRect(); const t = e.touches[0]; sigCtx.beginPath(); sigCtx.moveTo(t.clientX-r.left, t.clientY-r.top); });
sigPad.addEventListener('touchmove', function(e){ e.preventDefault(); if(drawing){ const r = sigPad.getBoundingClientRect(); const t = e.touches[0]; sigCtx.lineTo(t.clientX-r.left, t.clientY-r.top); sigCtx.stroke(); } });
sigPad.addEventListener('touchend', function(){ drawing = false; saveSignature(); });
function clearSignature() { sigCtx.clearRect(0,0,sigPad.width,sigPad.height); saveSignature(); }
function saveSignature() {
  signatureData = sigPad.toDataURL("image/png");
  localStorage.setItem('zelio_signature', signatureData);
}
function loadSignature() {
  if(signatureData) {
    const img = new Image();
    img.onload = function() { sigCtx.clearRect(0,0,sigPad.width,sigPad.height); sigCtx.drawImage(img,0,0,sigPad.width,sigPad.height); };
    img.src = signatureData;
  } else {
    sigCtx.clearRect(0,0,sigPad.width,sigPad.height);
  }
}
loadSignature();

// --- MENU D√âROULANT CAT√âGORIE EXISTANTE + AJOUT PRODUIT ---
function updateCatSelect() {
  const catSel = document.getElementById('cat-select');
  catSel.innerHTML = '<option value="">Cat√©gorie existante</option>';
  Object.keys(database).forEach(cat => {
    catSel.innerHTML += `<option value="${cat}">${cat}</option>`;
  });
}
updateCatSelect();

document.getElementById('cat-select').addEventListener('change', function() {
  if(this.value) {
    document.getElementById('new-cat').value = this.value;
  }
});
document.getElementById('new-cat').addEventListener('input', function() {
  if(this.value !== document.getElementById('cat-select').value) {
    document.getElementById('cat-select').value = "";
  }
});

function addProduct() {
  const cat = document.getElementById('new-cat').value.trim();
  const prod = document.getElementById('new-prod').value.trim();
  const price = parseFloat(document.getElementById('new-price').value);
  const time = parseFloat(document.getElementById('new-time').value);
  const unit = document.getElementById('new-unit').value.trim() || "u";
  if(!cat || !prod) return showToast("Cat√©gorie et nom du produit obligatoires !", "#ef4444");
  if(!database[cat]) database[cat] = {};
  if(database[cat][prod]) return showToast("Produit d√©j√† existant !", "#ef4444");
  database[cat][prod] = { price, time, unit };
  localStorage.setItem('zelio_full_v6', JSON.stringify(database));
  render();
  updateCatSelect();
  showToast("Produit ajout√© !");
  document.getElementById('new-cat').value = "";
  document.getElementById('cat-select').value = "";
  document.getElementById('new-prod').value = "";
  document.getElementById('new-price').value = 0;
  document.getElementById('new-time').value = 0;
  document.getElementById('new-unit').value = "";
}

// --- SUPPRESSION DE PRODUIT ---
function deleteProduct(cat, prod) {
  if(confirm("Supprimer ce produit ?")) {
    delete database[cat][prod];
    if(Object.keys(database[cat]).length===0) delete database[cat];
    localStorage.setItem('zelio_full_v6', JSON.stringify(database));
    render();
    updateCatSelect();
    showToast("Produit supprim√© !");
  }
}

// --- RENDU DYNAMIQUE ---
function render() {
  const configA = document.getElementById('config-accordion');
  const pricesA = document.getElementById('prices-accordion');
  configA.innerHTML = ''; pricesA.innerHTML = '';
  for (const [cat, prods] of Object.entries(database)) {
    const catId = cat.replace(/[^\w]/g, '');
    configA.innerHTML += `<div class="accordion-item"><button class="accordion-header" onclick="toggleAccordion(this)">${cat}</button><div class="accordion-content"><div class="grid-items" id="c-${catId}"></div></div></div>`;
    pricesA.innerHTML += `<div class="accordion-item"><button class="accordion-header" onclick="toggleAccordion(this)">Modifier Tarifs : ${cat}</button><div class="accordion-content"><div class="grid-items" id="p-${catId}"></div></div></div>`;
    for (const [name, obj] of Object.entries(prods)) {
      document.getElementById(`c-${catId}`).innerHTML += `
        <div class="item">
          <label>${name} <span style="color:#64748b;font-size:0.8em;">(${obj.unit})</span> <span style="color:#64748b;font-size:0.8em;">${obj.time}h</span></label>
          <select class="qty-in" data-cat="${cat}" data-prod="${name}">${Array.from({length:101},(_,i)=>`<option value="${i}">${i}</option>`).join('')}</select>
        </div>`;
      document.getElementById(`p-${catId}`).innerHTML += `
        <div class="item">
          <label>${name} <span style="color:#64748b;font-size:0.8em;">(${obj.unit})</span> <span style="color:#64748b;font-size:0.8em;">${obj.time}h</span></label>
          <input type="number" value="${obj.price}" class="price-in" data-cat="${cat}" data-prod="${name}">
          <input type="number" value="${obj.time}" step="0.01" class="time-in" data-cat="${cat}" data-prod="${name}" style="width:60px;" title="Dur√©e estim√©e (h)">
          <button class="btn-small btn-danger" onclick="deleteProduct('${cat.replace(/'/g,"\\'")}', '${name.replace(/'/g,"\\'")}')">Supprimer</button>
        </div>`;
    }
  }
  document.querySelectorAll('.qty-in, .price-in, .time-in').forEach(el => el.addEventListener('input', function() {
    calculate();
    saveFormData();
  }));
  // Recharge les quantit√©s sauvegard√©es
  if(formData.quantities) {
    document.querySelectorAll('.qty-in').forEach(s => {
      const key = s.dataset.cat + '||' + s.dataset.prod;
      if(formData.quantities[key] !== undefined) s.value = formData.quantities[key];
    });
  }
}
render();

// --- CALCULS ---
function calculate() {
  let total = 0, totalTime = 0;
  document.querySelectorAll('.price-in').forEach(i => { 
    database[i.dataset.cat][i.dataset.prod].price = parseFloat(i.value) || 0; 
  });
  document.querySelectorAll('.time-in').forEach(i => { 
    database[i.dataset.cat][i.dataset.prod].time = parseFloat(i.value) || 0; 
  });
  localStorage.setItem('zelio_full_v6', JSON.stringify(database));
  document.querySelectorAll('.qty-in').forEach(s => { 
    const q = parseInt(s.value);
    const obj = database[s.dataset.cat][s.dataset.prod];
    total += q * obj.price;
    totalTime += q * obj.time;
  });
  // Remise
  let discount = parseFloat(document.getElementById('discount').value) || 0;
  let totalRemise = total * (discount/100);
  // Total apr√®s remise
  let totalAfterRemise = total - totalRemise;
  // TVA
  let tva = parseFloat(document.getElementById('tva-rate').value) || 20;
  let tvaAmount = totalAfterRemise * (tva/100);
  // Acompte
  let deposit = parseFloat(document.getElementById('deposit').value) || 0;
  // Affichage
  document.getElementById('grand-total').innerText = totalAfterRemise.toLocaleString();
  document.getElementById('grand-time').innerText = totalTime.toFixed(2);
}
calculate();

// --- SAUVEGARDE AUTOMATIQUE DES FORMULAIRES ---
function saveFormData() {
  formData = {
    c_name: document.getElementById('c-name').value,
    c_phone: document.getElementById('c-phone').value,
    c_email: document.getElementById('c-email').value,
    c_addr: document.getElementById('c-addr').value,
    c_site: document.getElementById('c-site').value,
    c_type: document.getElementById('c-type').value,
    c_notes: document.getElementById('c-notes').value,
    c_notes_internal: document.getElementById('c-notes-internal').value,
    my_name: document.getElementById('my-name').value,
    my_siret: document.getElementById('my-siret').value,
    my_addr: document.getElementById('my-addr').value,
    my_ins: document.getElementById('my-ins').value,
    discount: document.getElementById('discount').value,
    deposit: document.getElementById('deposit').value,
    tva: document.getElementById('tva-rate').value,
    folder_status: document.getElementById('folder-status').value,
    quantities: {}
  };
  document.querySelectorAll('.qty-in').forEach(s => {
    const key = s.dataset.cat + '||' + s.dataset.prod;
    formData.quantities[key] = s.value;
  });
  localStorage.setItem('zelio_formdata', JSON.stringify(formData));
}
function loadFormData() {
  if(!formData) return;
  document.getElementById('c-name').value = formData.c_name || "";
  document.getElementById('c-phone').value = formData.c_phone || "";
  document.getElementById('c-email').value = formData.c_email || "";
  document.getElementById('c-addr').value = formData.c_addr || "";
  document.getElementById('c-site').value = formData.c_site || "";
  document.getElementById('c-type').value = formData.c_type || "";
  document.getElementById('c-notes').value = formData.c_notes || "";
  document.getElementById('c-notes-internal').value = formData.c_notes_internal || "";
  document.getElementById('my-name').value = formData.my_name || "";
  document.getElementById('my-siret').value = formData.my_siret || "";
  document.getElementById('my-addr').value = formData.my_addr || "";
  document.getElementById('my-ins').value = formData.my_ins || "";
  document.getElementById('discount').value = formData.discount || 0;
  document.getElementById('deposit').value = formData.deposit || 0;
  document.getElementById('tva-rate').value = formData.tva || 20;
  document.getElementById('folder-status').value = formData.folder_status || "Brouillon";
  // Les quantit√©s sont recharg√©es dans render()
}
loadFormData();
document.querySelectorAll('#c-name,#c-phone,#c-email,#c-addr,#c-site,#c-type,#c-notes,#c-notes-internal,#my-name,#my-siret,#my-addr,#my-ins,#discount,#deposit,#tva-rate,#folder-status').forEach(el => {
  el.addEventListener('input', function() { saveFormData(); calculate(); });
});

// --- PDF DEVIS (avec signature, logo, remise, acompte, tva, statut) ---
// Remplacement par PDFMake
function generatePDF() {
  saveFolder();
  const c = getClientData();
  const m = getArtisanData();
  let rows = [], totalTime = 0, total = 0;
  document.querySelectorAll('.qty-in').forEach(s => {
    const q = parseInt(s.value);
    if(q > 0) {
      const obj = database[s.dataset.cat][s.dataset.prod];
      rows.push([
        {text: s.dataset.prod + ` (${obj.unit})`, margin: [0, 2, 0, 2]},
        {text: q.toString(), alignment: 'center', margin: [0, 2, 0, 2]},
        {text: obj.price.toFixed(2) + " ‚Ç¨", alignment: 'right', margin: [0, 2, 0, 2]},
        {text: (q*obj.price).toFixed(2) + " ‚Ç¨", alignment: 'right', margin: [0, 2, 0, 2]}
      ]);
      totalTime += q * obj.time;
      total += q * obj.price;
    }
  });
  if(!rows.length) return showToast("Le devis est vide !", "#ef4444");
  let discount = parseFloat(document.getElementById('discount').value) || 0;
  let totalRemise = total * (discount/100);
  let totalAfterRemise = total - totalRemise;
  let tva = parseFloat(document.getElementById('tva-rate').value) || 20;
  let tvaAmount = totalAfterRemise * (tva/100);
  let deposit = parseFloat(document.getElementById('deposit').value) || 0;
  let totalTTC = totalAfterRemise + tvaAmount;
  let reste = totalTTC - deposit;
  let statut = document.getElementById('folder-status').value;

  // Logo et signature en base64
  function getImageData(url, cb) {
    if(!url) return cb(null);
    let img = new Image();
    img.crossOrigin = "Anonymous";
    img.onload = function() {
      let canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      canvas.getContext('2d').drawImage(img, 0, 0);
      cb(canvas.toDataURL());
    };
    img.onerror = function() { cb(null); };
    img.src = url;
  }

  // G√©n√©ration PDFMake
  getImageData(logoData, function(logoBase64) {
    getImageData(signatureData, function(sigBase64) {
      let docDefinition = {
        pageMargins: [40, 40, 40, 40],
        content: [
          {
            columns: [
              [
                logoBase64 ? {image: logoBase64, width: 90, margin: [0,0,0,10]} : {},
                {text: m.name || 'DEVIS √âLECTRIQUE', color: '#4f46e5', fontSize: 20, bold: true, margin: [0,0,0,0]},
                {text: `SIRET: ${m.siret}\n${m.addr}`, fontSize: 10, margin: [0,5,0,0]}
              ],
              [
                {text: `DEVIS N¬∞ ${Math.floor(Math.random()*1000)}`, alignment: 'right', fontSize: 16, bold: true},
                {text: `Date: ${new Date().toLocaleDateString()}`, alignment: 'right', fontSize: 10, margin: [0,5,0,0]},
                {text: statut, alignment: 'right', color: '#4f46e5', fontSize: 12, margin: [0,5,0,0], decoration: 'underline'}
              ]
            ]
          },
          {text: " "},
          {
            columns: [
              {
                width: '48%',
                stack: [
                  {text: "CLIENT :", color: '#4f46e5', bold: true, fontSize: 12},
                  {text: `${c.name}\n${c.addr}\nT√©l: ${c.phone}\n${c.email}`, fontSize: 10}
                ],
                fillColor: '#f8fafc',
                margin: [0,0,10,0],
                border: [false, false, false, false],
                style: 'box'
              },
              {
                width: '48%',
                stack: [
                  {text: "D√âTAILS CHANTIER :", color: '#4f46e5', bold: true, fontSize: 12},
                  {text: `Type: ${c.type}\nLieu: ${c.site || c.addr}`, fontSize: 10}
                ],
                border: [true, true, true, true],
                margin: [10,0,0,0],
                style: 'box'
              }
            ]
          },
          {text: " "},
          {text: "Notes du Chantier", color: '#4f46e5', fontSize: 14, bold: true, margin: [0,10,0,2]},
          {text: c.notes || "Aucune note.", fillColor: '#f8fafc', fontSize: 10, margin: [0,0,0,10]},
          {
            table: {
              headerRows: 1,
              widths: ['*', 30, 50, 60],
              body: [
                [
                  {text: "D√©signation", fillColor: '#4f46e5', color: 'white', bold: true, fontSize: 12},
                  {text: "Qt√©", fillColor: '#4f46e5', color: 'white', bold: true, fontSize: 12},
                  {text: "PU HT", fillColor: '#4f46e5', color: 'white', bold: true, fontSize: 12},
                  {text: "Total HT", fillColor: '#4f46e5', color: 'white', bold: true, fontSize: 12}
                ]
              ].concat(rows)
            },
            layout: 'lightHorizontalLines',
            margin: [0,10,0,0]
          },
          {
            alignment: 'right',
            margin: [0,20,0,0],
            table: {
              widths: ['*', 120],
              body: [
                ["Total HT :", {text: total.toLocaleString() + " ‚Ç¨", bold: true}],
                ["Remise :", {text: `${discount}% (-${totalRemise.toFixed(2)} ‚Ç¨)`}],
                ["Total HT apr√®s remise :", {text: totalAfterRemise.toFixed(2) + " ‚Ç¨"}],
                [`TVA (${tva}%) :`, {text: tvaAmount.toFixed(2) + " ‚Ç¨"}],
                [{text: "TOTAL TTC :", color: '#4f46e5', bold: true}, {text: totalTTC.toFixed(2) + " ‚Ç¨", color: '#4f46e5', bold: true}],
                ["Acompte :", {text: deposit.toFixed(2) + " ‚Ç¨"}],
                ["Reste √† payer :", {text: reste.toFixed(2) + " ‚Ç¨"}],
                ["Temps estim√© :", {text: totalTime.toFixed(2) + " h"}]
              ]
            },
            layout: 'noBorders'
          },
          {text: " "},
          {text: "Conditions : Valable 30 jours. Assurance D√©cennale : " + m.ins, fontSize: 9, color: '#666', margin: [0,10,0,0]},
          {text: "Bon pour accord le : ____ / ____ / 20____    Cachet et Signature :", fontSize: 9, color: '#666', margin: [0,10,0,0]},
          sigBase64 ? {image: sigBase64, width: 220, margin: [0,10,0,0]} : {text: "Non sign√©e", color: '#888', margin: [0,10,0,0]}
        ],
        styles: {
          box: {border: [true, true, true, true], margin: [0,0,0,0], fontSize: 10, borderColor: '#e2e8f0', borderWidth: 1, borderRadius: 10}
        }
      };
      pdfMake.createPdf(docDefinition).download(`Devis_ZELIO_${c.name.replace(/[^\w\d]/g,'_')}.pdf`);
      showToast("PDF g√©n√©r√© !");
    });
  });
}

// --- PDF RAPPORT (idem, + photos, + notes internes) ---
// Remplacement par PDFMake
function generateReport() {
  saveFolder();
  const c = getClientData();
  const m = getArtisanData();
  let rows = [], totalTime = 0, total = 0;
  document.querySelectorAll('.qty-in').forEach(s => {
    const q = parseInt(s.value);
    if(q > 0) {
      const obj = database[s.dataset.cat][s.dataset.prod];
      rows.push([
        {text: s.dataset.prod + ` (${obj.unit})`, margin: [0, 2, 0, 2]},
        {text: q.toString(), alignment: 'center', margin: [0, 2, 0, 2]},
        {text: obj.price.toFixed(2) + " ‚Ç¨", alignment: 'right', margin: [0, 2, 0, 2]},
        {text: (q*obj.price).toFixed(2) + " ‚Ç¨", alignment: 'right', margin: [0, 2, 0, 2]}
      ]);
      totalTime += q * obj.time;
      total += q * obj.price;
    }
  });
  let discount = parseFloat(document.getElementById('discount').value) || 0;
  let totalRemise = total * (discount/100);
  let totalAfterRemise = total - totalRemise;
  let tva = parseFloat(document.getElementById('tva-rate').value) || 20;
  let tvaAmount = totalAfterRemise * (tva/100);
  let deposit = parseFloat(document.getElementById('deposit').value) || 0;
  let totalTTC = totalAfterRemise + tvaAmount;
  let reste = totalTTC - deposit;
  let statut = document.getElementById('folder-status').value;

  // Logo et signature en base64
  function getImageData(url, cb) {
    if(!url) return cb(null);
    let img = new Image();
    img.crossOrigin = "Anonymous";
    img.onload = function() {
      let canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      canvas.getContext('2d').drawImage(img, 0, 0);
      cb(canvas.toDataURL());
    };
    img.onerror = function() { cb(null); };
    img.src = url;
  }

  // G√©n√©ration PDFMake
  getImageData(logoData, function(logoBase64) {
    getImageData(signatureData, function(sigBase64) {
      // Photos chantier
      let photosContent = [];
      if(photos.length) {
        let photoRow = [];
        for(let i=0; i<photos.length; i++) {
          photoRow.push({image: photos[i], width: 180, height: 130, margin: [0,0,10,10]});
          if(photoRow.length === 3 || i === photos.length-1) {
            photosContent.push({columns: photoRow});
            photoRow = [];
          }
        }
      }
      let docDefinition = {
        pageMargins: [40, 40, 40, 40],
        content: [
          {
            columns: [
              [
                logoBase64 ? {image: logoBase64, width: 90, margin: [0,0,0,10]} : {},
                {text: m.name || 'RAPPORT DE CHANTIER', color: '#4f46e5', fontSize: 20, bold: true, margin: [0,0,0,0]},
                {text: `SIRET: ${m.siret}\n${m.addr}`, fontSize: 10, margin: [0,5,0,0]}
              ],
              [
                {text: `RAPPORT N¬∞ ${Math.floor(Math.random()*1000)}`, alignment: 'right', fontSize: 16, bold: true},
                {text: `Date: ${new Date().toLocaleDateString()}`, alignment: 'right', fontSize: 10, margin: [0,5,0,0]},
                {text: statut, alignment: 'right', color: '#4f46e5', fontSize: 12, margin: [0,5,0,0], decoration: 'underline'}
              ]
            ]
          },
          {text: " "},
          {
            columns: [
              {
                width: '48%',
                stack: [
                  {text: "CLIENT :", color: '#4f46e5', bold: true, fontSize: 12},
                  {text: `${c.name}\n${c.addr}\nT√©l: ${c.phone}\n${c.email}`, fontSize: 10}
                ],
                fillColor: '#f8fafc',
                margin: [0,0,10,0],
                border: [false, false, false, false],
                style: 'box'
              },
              {
                width: '48%',
                stack: [
                  {text: "D√âTAILS CHANTIER :", color: '#4f46e5', bold: true, fontSize: 12},
                  {text: `Type: ${c.type}\nLieu: ${c.site || c.addr}`, fontSize: 10}
                ],
                border: [true, true, true, true],
                margin: [10,0,0,0],
                style: 'box'
              }
            ]
          },
          {text: " "},
          {text: "Photos du Chantier", color: '#4f46e5', fontSize: 14, bold: true, margin: [0,10,0,2]},
          photosContent.length ? photosContent : {text: "Aucune photo ajout√©e.", color: '#888', fontSize: 10, margin: [0,0,0,10]},
          {text: "Notes du Chantier", color: '#4f46e5', fontSize: 14, bold: true, margin: [0,10,0,2]},
          {text: c.notes || "Aucune note.", fillColor: '#f8fafc', fontSize: 10, margin: [0,0,0,10]},
          {text: "Notes internes", color: '#4f46e5', fontSize: 14, bold: true, margin: [0,10,0,2]},
          {text: c.notes_internal || "Aucune note interne.", fillColor: '#f1f5f9', color: '#888', fontSize: 10, margin: [0,0,0,10]},
          {text: "Liste des Prestations", color: '#4f46e5', fontSize: 14, bold: true, margin: [0,10,0,2]},
          {
            table: {
              headerRows: 1,
              widths: ['*', 30, 50, 60],
              body: [
                [
                  {text: "D√©signation", fillColor: '#4f46e5', color: 'white', bold: true, fontSize: 12},
                  {text: "Qt√©", fillColor: '#4f46e5', color: 'white', bold: true, fontSize: 12},
                  {text: "PU HT", fillColor: '#4f46e5', color: 'white', bold: true, fontSize: 12},
                  {text: "Total HT", fillColor: '#4f46e5', color: 'white', bold: true, fontSize: 12}
                ]
              ].concat(rows.length ? rows : [[{text:"Aucune prestation s√©lectionn√©e.", colSpan:4, alignment:'center', color:'#888', margin:[0,10,0,10]}, {}, {}, {}]])
            },
            layout: 'lightHorizontalLines',
            margin: [0,10,0,0]
          },
          {
            alignment: 'right',
            margin: [0,20,0,0],
            table: {
              widths: ['*', 120],
              body: [
                ["Total HT :", {text: total.toLocaleString() + " ‚Ç¨", bold: true}],
                ["Remise :", {text: `${discount}% (-${totalRemise.toFixed(2)} ‚Ç¨)`}],
                ["Total HT apr√®s remise :", {text: totalAfterRemise.toFixed(2) + " ‚Ç¨"}],
                [`TVA (${tva}%) :`, {text: tvaAmount.toFixed(2) + " ‚Ç¨"}],
                [{text: "TOTAL TTC :", color: '#4f46e5', bold: true}, {text: totalTTC.toFixed(2) + " ‚Ç¨", color: '#4f46e5', bold: true}],
                ["Acompte :", {text: deposit.toFixed(2) + " ‚Ç¨"}],
                ["Reste √† payer :", {text: reste.toFixed(2) + " ‚Ç¨"}],
                ["Temps estim√© :", {text: totalTime.toFixed(2) + " h"}]
              ]
            },
            layout: 'noBorders'
          },
          {text: " "},
          {text: "Conditions : Valable 30 jours. Assurance D√©cennale : " + m.ins, fontSize: 9, color: '#666', margin: [0,10,0,0]},
          {text: "Signature du client :", fontSize: 9, color: '#666', margin: [0,10,0,0]},
          sigBase64 ? {image: sigBase64, width: 220, margin: [0,10,0,0]} : {text: "Non sign√©e", color: '#888', margin: [0,10,0,0]}
        ],
        styles: {
          box: {border: [true, true, true, true], margin: [0,0,0,0], fontSize: 10, borderColor: '#e2e8f0', borderWidth: 1, borderRadius: 10}
        }
      };
      pdfMake.createPdf(docDefinition).download(`Rapport_ZELIO_${c.name.replace(/[^\w\d]/g,'_')}.pdf`);
      showToast("PDF g√©n√©r√© !");
    });
  });
}

// --- DOSSIERS CLIENTS (SAUVEGARDE) ---
function saveFolder() {
  const c = getClientData();
  const m = getArtisanData();
  let quantities = {};
  document.querySelectorAll('.qty-in').forEach(s => {
    const key = s.dataset.cat + '||' + s.dataset.prod;
    quantities[key] = s.value;
  });
  const folder = {
    client: c,
    artisan: m,
    quantities,
    photos: [...photos],
    date: new Date().toISOString(),
    signature: signatureData,
    discount: document.getElementById('discount').value,
    deposit: document.getElementById('deposit').value,
    tva: document.getElementById('tva-rate').value,
    status: document.getElementById('folder-status').value
  };
  let idx = folders.findIndex(f => f.client.name === c.name && f.client.addr === c.addr);
  if(idx !== -1) folders[idx] = folder;
  else folders.push(folder);
  localStorage.setItem('zelio_folders', JSON.stringify(folders));
}
function renderFolders() {
  const fDiv = document.getElementById('folders-list');
  let filter = document.getElementById('search-folder').value.toLowerCase();
  fDiv.innerHTML = '';
  let filtered = folders.filter(f => f.client.name.toLowerCase().includes(filter) || f.client.addr.toLowerCase().includes(filter) || (f.status||"").toLowerCase().includes(filter));
  if(!filtered.length) { fDiv.innerHTML = "<p style='color:#888;'>Aucun dossier sauvegard√©.</p>"; return; }
  filtered.forEach((f, i) => {
    fDiv.innerHTML += `
      <div class="item">
        <label><b>${f.client.name}</b> - ${f.client.addr} <span style="color:#64748b;font-size:0.8em;">(${new Date(f.date).toLocaleDateString()})</span> <span style="background:#e0e7ff; color:#4f46e5; padding:2px 8px; border-radius:6px; font-size:12px;">${f.status||"Brouillon"}</span></label>
        <button class="btn-small" onclick="loadFolder(${i})">Charger</button>
        <button class="btn-small btn-danger" onclick="deleteFolder(${i})">Supprimer</button>
      </div>
    `;
  });
}
function loadFolder(idx) {
  const f = folders[idx];
  document.getElementById('c-name').value = f.client.name;
  document.getElementById('c-phone').value = f.client.phone;
  document.getElementById('c-email').value = f.client.email;
  document.getElementById('c-addr').value = f.client.addr;
  document.getElementById('c-site').value = f.client.site;
  document.getElementById('c-type').value = f.client.type;
  document.getElementById('c-notes').value = f.client.notes;
  document.getElementById('c-notes-internal').value = f.client.notes_internal || "";
  document.getElementById('my-name').value = f.artisan.name;
  document.getElementById('my-siret').value = f.artisan.siret;
  document.getElementById('my-addr').value = f.artisan.addr;
  document.getElementById('my-ins').value = f.artisan.ins;
  document.getElementById('discount').value = f.discount || 0;
  document.getElementById('deposit').value = f.deposit || 0;
  document.getElementById('tva-rate').value = f.tva || 20;
  document.getElementById('folder-status').value = f.status || "Brouillon";
  document.querySelectorAll('.qty-in').forEach(s => {
    const key = s.dataset.cat + '||' + s.dataset.prod;
    s.value = f.quantities[key] || 0;
  });
  photos = [...f.photos];
  localStorage.setItem('zelio_photos', JSON.stringify(photos));
  showPhotoPreview();
  signatureData = f.signature || "";
  localStorage.setItem('zelio_signature', signatureData);
  loadSignature();
  calculate();
  saveFormData();
  showToast("Dossier charg√© !");
}
function deleteFolder(idx) {
  if(confirm("Supprimer ce dossier ?")) {
    folders.splice(idx,1);
    localStorage.setItem('zelio_folders', JSON.stringify(folders));
    renderFolders();
    showToast("Dossier supprim√© !");
  }
}
document.getElementById('search-folder').addEventListener('input', renderFolders);

// --- OUTILS ---
function getClientData() {
  return {
    name: document.getElementById('c-name').value,
    phone: document.getElementById('c-phone').value,
    email: document.getElementById('c-email').value,
    addr: document.getElementById('c-addr').value,
    site: document.getElementById('c-site').value,
    type: document.getElementById('c-type').value,
    notes: document.getElementById('c-notes').value,
    notes_internal: document.getElementById('c-notes-internal').value
  };
}
function getArtisanData() {
  return {
    name: document.getElementById('my-name').value,
    siret: document.getElementById('my-siret').value,
    addr: document.getElementById('my-addr').value,
    ins: document.getElementById('my-ins').value
  };
}

// --- EXPORT/IMPORT ---
function exportData() {
  const data = {
    database, photos, clients, folders, formData, logoData
  };
  const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = "zelio_backup.json";
  a.click();
  URL.revokeObjectURL(url);
  showToast("Export JSON OK !");
}
document.getElementById('import-file').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    try {
      const data = JSON.parse(evt.target.result);
      if(data.database) database = data.database;
      if(data.photos) photos = data.photos;
      if(data.clients) clients = data.clients;
      if(data.folders) folders = data.folders;
      if(data.formData) formData = data.formData;
      if(data.logoData) { logoData = data.logoData; localStorage.setItem('zelio_logo', logoData); }
      localStorage.setItem('zelio_full_v6', JSON.stringify(database));
      localStorage.setItem('zelio_photos', JSON.stringify(photos));
      localStorage.setItem('zelio_clients', JSON.stringify(clients));
      localStorage.setItem('zelio_folders', JSON.stringify(folders));
      localStorage.setItem('zelio_formdata', JSON.stringify(formData));
      showToast("Importation r√©ussie !");
      location.reload();
    } catch(e) { showToast("Fichier invalide.", "#ef4444"); }
  };
  reader.readAsText(file);
});

// --- EXPORT CSV ---
function exportClientsCSV() {
  let csv = "Nom;T√©l√©phone;Email;Adresse;Site;Type;Notes;Notes internes\n";
  clients.forEach(c => {
    csv += `"${c.name}";"${c.phone}";"${c.email}";"${c.addr}";"${c.site}";"${c.type}";"${c.notes}";"${c.notes_internal||""}"\n`;
  });
  downloadCSV(csv, "clients_zelio.csv");
}
function exportFoldersCSV() {
  let csv = "Nom client;Adresse;Date;Statut;Total HT;Remise (%);Acompte;TVA (%);Notes;Notes internes\n";
  folders.forEach(f => {
    let total = 0;
    for(let k in f.quantities) {
      let [cat, prod] = k.split('||');
      let q = parseInt(f.quantities[k]);
      if(q>0) total += (database[cat] && database[cat][prod]) ? database[cat][prod].price*q : 0;
    }
    csv += `"${f.client.name}";"${f.client.addr}";"${new Date(f.date).toLocaleDateString()}";"${f.status||"Brouillon"}";"${total}";"${f.discount||0}";"${f.deposit||0}";"${f.tva||20}";"${f.client.notes||""}";"${f.client.notes_internal||""}"\n`;
  });
  downloadCSV(csv, "dossiers_zelio.csv");
}
function exportProductsCSV() {
  let csv = "Cat√©gorie;Produit;Prix;Temps;Unit√©\n";
  for(let cat in database) {
    for(let prod in database[cat]) {
      let o = database[cat][prod];
      csv += `"${cat}";"${prod}";"${o.price}";"${o.time}";"${o.unit}"\n`;
    }
  }
  downloadCSV(csv, "produits_zelio.csv");
}
function downloadCSV(csv, filename) {
  const blob = new Blob([csv], {type: "text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
  showToast("Export CSV OK !");
}

// --- INIT ---
renderClientSelect();
showPhotoPreview();
renderClients();
renderFolders();
updateLogoPreview();
loadSignature();
</script>
</body>
</html>

