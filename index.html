<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ZELIO - Solution Devis √âlectricit√©</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
:root { --primary: #4f46e5; --bg: #f1f5f9; --card: #ffffff; --text: #1f2937; --accent: #10b981; }
* { box-sizing: border-box; }
body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 180px; }
.header-brand { background: white; padding: 1.5rem; text-align: center; border-bottom: 1px solid #e2e8f0; }
.logo-text { font-size: 2.5rem; font-weight: 900; color: var(--primary); letter-spacing: -2px; margin: 0; }
.logo-subtitle { font-size: 0.8rem; color: #64748b; text-transform: uppercase; letter-spacing: 2px; margin-top: -5px; }
.nav-tabs { display: flex; justify-content: center; gap: 10px; background: white; padding: 0.8rem; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); flex-wrap: wrap;}
.tab-btn { padding: 0.7rem 1.1rem; border: none; background: #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; flex: 1 1 120px; min-width: 90px; max-width: 180px; }
.tab-btn.active { background: var(--primary); color: white; }
.container { max-width: 1100px; margin: auto; padding: 1rem; }
.page { display: none; }
.page.active { display: block; }
.form-section { background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid #e2e8f0; }
.form-section h2 { margin-top: 0; font-size: 1.1rem; color: var(--primary); margin-bottom: 1rem; }
.grid-forms { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; }
.form-group label { display: block; font-size: 0.75rem; font-weight: bold; margin-bottom: 4px; color: #64748b; }
input.full-width, textarea.full-width, select.full-width { width: 100%; padding: 0.7rem; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 0.9rem; }
textarea.full-width { resize: vertical; }
.accordion-controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 1rem; }
.btn-small { padding: 6px 12px; font-size: 0.75rem; background: #cbd5e1; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
.btn-danger { background: #fee2e2; color: #ef4444; }
.accordion-item { background: var(--card); border-radius: 12px; margin-bottom: 0.6rem; overflow: hidden; border: 1px solid #e2e8f0; }
.accordion-header { width: 100%; padding: 1.1rem; background: white; border: none; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: bold; text-align: left; }
.accordion-header::after { content: '+'; color: var(--primary); font-size: 1.2rem; }
.accordion-item.open .accordion-header { border-bottom: 1px solid #f1f5f9; color: var(--primary); }
.accordion-item.open .accordion-header::after { content: '-'; }
.accordion-content { display: none; padding: 1rem; background: #fafafa; }
.accordion-item.open .accordion-content { display: block; }
.grid-items { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 0.7rem; }
.item { display: flex; align-items: center; justify-content: space-between; background: white; padding: 0.6rem 0.9rem; border-radius: 8px; border: 1px solid #e2e8f0; position:relative;}
.item label { font-size: 0.85rem; flex: 1; margin-right: 10px; }
select, input[type="number"] { width: 70px; padding: 0.4rem; border-radius: 6px; border: 1px solid #cbd5e1; }
.footer { position: fixed; bottom: 0; width: 100%; background: white; padding: 1rem; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); z-index: 1001; flex-wrap:wrap;}
.total-amount { font-size: 1.5rem; font-weight: 800; color: var(--primary); }
.btn-generate { background: var(--primary); color: white; padding: 0.9rem 2rem; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin: 0 5px;}
.footer-info { font-size: 1rem; color: #64748b; margin: 0 10px;}
.toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 12px 24px; border-radius: 8px; font-size: 1rem; z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.15);}
@media (max-width: 700px) {
  .footer { flex-direction: column; gap: 10px; }
  .btn-generate { width: 100%; }
  .nav-tabs { flex-wrap: wrap; gap: 5px; }
  .tab-btn { min-width: 80px; font-size: 0.85rem; padding: 0.6rem 0.5rem; }
}
@media (max-width: 500px) {
  .nav-tabs { flex-direction: column; align-items: stretch; }
  .tab-btn { width: 100%; min-width: unset; }
}
</style>
</head>
<body>

<div class="header-brand">
    <h1 class="logo-text">ZELIO</h1>
    <div class="logo-subtitle">Logiciel de Chiffrage Professionnel</div>
</div>

<div class="nav-tabs" role="tablist">
  <button class="tab-btn active" onclick="showPage('config', event)" aria-selected="true" aria-controls="page-config">üìã Devis</button>
  <button class="tab-btn" onclick="showPage('prices', event)" aria-selected="false" aria-controls="page-prices">‚öôÔ∏è Param√®tres</button>
  <button class="tab-btn" onclick="showPage('clients', event)" aria-selected="false" aria-controls="page-clients">üë• Clients</button>
  <button class="tab-btn" onclick="showPage('export', event)" aria-selected="false" aria-controls="page-export">üíæ Sauvegarde</button>
  <button class="tab-btn" onclick="showPage('folders', event)" aria-selected="false" aria-controls="page-folders">üìÅ Dossiers</button>
</div>

<div class="container">
  <!-- PAGE DEVIS -->
  <div id="page-config" class="page active">
    <div class="form-section">
      <h2>üë§ Informations Client & Chantier</h2>
      <div class="grid-forms">
        <div class="form-group">
          <label>Client enregistr√©</label>
          <select id="client-select" class="full-width">
            <option value="">-- Nouveau client --</option>
          </select>
        </div>
        <div class="form-group"><label>Nom du Client</label><input type="text" id="c-name" class="full-width" placeholder="Ex: Jean Dupont" required></div>
        <div class="form-group"><label>T√©l√©phone</label><input type="text" id="c-phone" class="full-width" placeholder="06 00 00 00 00" pattern="^0[1-9]([-. ]?[0-9]{2}){4}$"></div>
        <div class="form-group"><label>Email</label><input type="email" id="c-email" class="full-width" placeholder="client@email.com"></div>
        <div class="form-group"><label>Adresse de Facturation</label><input type="text" id="c-addr" class="full-width" placeholder="Adresse compl√®te"></div>
        <div class="form-group"><label>Adresse du Chantier</label><input type="text" id="c-site" class="full-width" placeholder="Si diff√©rente"></div>
        <div class="form-group"><label>Type de bien</label><input type="text" id="c-type" class="full-width" placeholder="Ex: Maison T4"></div>
        <div class="form-group" style="grid-column:1/-1;">
          <label>Notes du chantier</label>
          <textarea id="c-notes" class="full-width" placeholder="Ex : acc√®s difficile, pr√©sence d‚Äôanimaux, etc." style="min-height:60px;"></textarea>
        </div>
      </div>
      <button class="btn-small" onclick="saveClient()">üíæ Enregistrer ce client</button>
    </div>
    <div class="form-section">
      <h2>üì∏ Photos du Chantier</h2>
      <input type="file" id="site-photos" accept="image/*" multiple capture="environment" style="margin-bottom:10px;">
      <button class="btn-small" onclick="takePhoto()">üì∑ Prendre une photo</button>
      <video id="camera-stream" style="display:none; width:100%; max-width:300px; margin:10px 0;" autoplay></video>
      <button id="capture-btn" class="btn-small" style="display:none;">Capturer</button>
      <canvas id="photo-canvas" style="display:none;"></canvas>
      <div id="photo-preview" style="display:flex; gap:10px; flex-wrap:wrap;"></div>
    </div>
    <div class="accordion-controls">
        <button class="btn-small" onclick="toggleAll(true)">Tout ouvrir</button>
        <button class="btn-small" onclick="toggleAll(false)">Tout fermer</button>
        <button class="btn-small btn-danger" onclick="resetQuantities()">Vider le panier</button>
    </div>
    <div id="config-accordion"></div>
  </div>

  <!-- PAGE PRIX -->
  <div id="page-prices" class="page">
    <div class="form-section">
        <h2>üõ†Ô∏è Mes Informations Artisan</h2>
        <div class="grid-forms">
            <div class="form-group"><label>Nom Entreprise / Nom</label><input type="text" id="my-name" class="full-width"></div>
            <div class="form-group"><label>SIRET</label><input type="text" id="my-siret" class="full-width" pattern="^\d{14}$"></div>
            <div class="form-group"><label>Adresse Pro</label><input type="text" id="my-addr" class="full-width"></div>
            <div class="form-group"><label>Assurance D√©cennale</label><input type="text" id="my-ins" class="full-width"></div>
        </div>
        <button class="btn-small btn-danger" style="margin-top:20px;" onclick="fullReset()">‚ö†Ô∏è R√©initialiser TOUTE la base de donn√©es</button>
    </div>
    <div id="prices-accordion"></div>
  </div>

  <!-- PAGE CLIENTS -->
  <div id="page-clients" class="page">
    <div class="form-section">
      <h2>üë• Mes Clients Enregistr√©s</h2>
      <div id="clients-list"></div>
    </div>
  </div>

  <!-- PAGE EXPORT -->
  <div id="page-export" class="page">
    <div class="form-section">
      <h2>üíæ Sauvegarde / Restauration</h2>
      <button class="btn-small" onclick="exportData()">Exporter la base (JSON)</button>
      <input type="file" id="import-file" accept=".json" style="margin-top:10px;">
      <p style="font-size:0.9em; color:#64748b;">Exportez ou importez toutes vos donn√©es (produits, clients, photos, dossiers, etc.)</p>
    </div>
  </div>

  <!-- PAGE DOSSIERS -->
  <div id="page-folders" class="page">
    <div class="form-section">
      <h2>üìÅ Dossiers Clients</h2>
      <div id="folders-list"></div>
    </div>
  </div>
</div>

<div class="footer">
  <div class="footer-info">Total HT : <span class="total-amount"><span id="grand-total">0</span>‚Ç¨</span></div>
  <div class="footer-info">Temps estim√© : <span id="grand-time">0</span> h</div>
  <button class="btn-generate" onclick="generatePDF()">G√âN√âRER LE DEVIS</button>
  <button class="btn-generate" style="background:#10b981;" onclick="generateReport()">G√âN√âRER LE RAPPORT</button>
</div>

<div id="toast" class="toast" style="display:none;"></div>

<script>
// --- TOAST FEEDBACK ---
function showToast(msg, color="#10b981") {
  const t = document.getElementById('toast');
  t.innerText = msg;
  t.style.background = color;
  t.style.display = "block";
  setTimeout(()=>{ t.style.display="none"; }, 2200);
}

// --- BASE DE DONN√âES AVEC UNIT√âS ---
const defaultDatabase = {
  "‚ö° √âclairage Int√©rieur": {
    "Spot encastr√© LED": { price: 45, time: 0.5, unit: "u" },
    "Spot en saillie": { price: 50, time: 0.5, unit: "u" },
    "Spot orientable": { price: 55, time: 0.5, unit: "u" },
    "Plafonnier": { price: 65, time: 0.7, unit: "u" },
    "Suspension": { price: 75, time: 0.7, unit: "u" },
    "Applique murale": { price: 55, time: 0.5, unit: "u" },
    "R√©glette LED garage": { price: 45, time: 0.4, unit: "u" },
    "Ruban LED (ml)": { price: 25, time: 0.1, unit: "m" },
    "Profil√© Alu pour LED": { price: 30, time: 0.1, unit: "m" },
    "Variateur de lumi√®re": { price: 50, time: 0.2, unit: "u" },
    "D√©tecteur de pr√©sence": { price: 95, time: 0.3, unit: "u" },
    "Transformateur LED": { price: 35, time: 0.2, unit: "u" }
  },
  "üîå Prises & Interrupteurs": {
    "Prise de courant 16A": { price: 35, time: 0.2, unit: "u" },
    "Prise √©tanche IP55": { price: 45, time: 0.25, unit: "u" },
    "Prise USB (A+C)": { price: 60, time: 0.25, unit: "u" },
    "Prise RJ45 Cat6": { price: 65, time: 0.3, unit: "u" },
    "Prise TV / Satellite": { price: 45, time: 0.2, unit: "u" },
    "Interrupteur simple": { price: 25, time: 0.15, unit: "u" },
    "Va-et-vient": { price: 35, time: 0.2, unit: "u" },
    "Bouton poussoir": { price: 32, time: 0.15, unit: "u" },
    "Double va-et-vient": { price: 45, time: 0.25, unit: "u" },
    "Sortie de c√¢ble": { price: 20, time: 0.1, unit: "u" }
  },
  "üßØ C√¢blage & Cheminement": {
    "C√¢ble 3G1.5 (ml)": { price: 3, time: 0.01, unit: "m" },
    "C√¢ble 3G2.5 (ml)": { price: 4, time: 0.01, unit: "m" },
    "C√¢ble RJ45 (ml)": { price: 4.5, time: 0.01, unit: "m" },
    "Gaine ICTA √ò20 (ml)": { price: 2.5, time: 0.01, unit: "m" },
    "Gaine ICTA √ò25 (ml)": { price: 3, time: 0.01, unit: "m" },
    "Goulotte 20x12 (ml)": { price: 12, time: 0.02, unit: "m" },
    "Goulotte 40x20 (ml)": { price: 18, time: 0.02, unit: "m" },
    "Bo√Æte de d√©rivation": { price: 15, time: 0.1, unit: "u" }
  },
  "üì¶ Tableaux & Protections": {
    "Tableau √©lectrique nu": { price: 150, time: 1.5, unit: "u" },
    "Disjoncteur 10A/16A": { price: 25, time: 0.15, unit: "u" },
    "Disjoncteur 20A/32A": { price: 35, time: 0.15, unit: "u" },
    "Interrupteur Diff√©rentiel 40A": { price: 95, time: 0.2, unit: "u" },
    "Interrupteur Diff√©rentiel 63A": { price: 130, time: 0.2, unit: "u" },
    "Disjoncteur diff√©rentiel": { price: 115, time: 0.2, unit: "u" },
    "Parafoudre": { price: 170, time: 0.3, unit: "u" },
    "Contacteur Jour/Nuit": { price: 85, time: 0.2, unit: "u" },
    "T√©l√©rupteur": { price: 70, time: 0.2, unit: "u" },
    "Bornier de terre": { price: 15, time: 0.05, unit: "u" }
  },
  "üè† Domotique & Connect√©": {
    "Micromodule volet roulant": { price: 85, time: 0.3, unit: "u" },
    "Micromodule √©clairage": { price: 80, time: 0.3, unit: "u" },
    "Pack d√©marrage connect√©": { price: 180, time: 0.5, unit: "u" },
    "Thermostat connect√©": { price: 230, time: 0.5, unit: "u" },
    "Capteur ouverture fen√™tre": { price: 55, time: 0.1, unit: "u" },
    "Passerelle Wifi/Zigbee": { price: 110, time: 0.2, unit: "u" }
  },
  "üö™ Ouvertures Automatis√©es": {
    "Moteur volet roulant": { price: 290, time: 1, unit: "u" },
    "Motorisation portail battant": { price: 980, time: 3, unit: "u" },
    "Motorisation portail coulissant": { price: 1100, time: 3, unit: "u" },
    "Cellule de s√©curit√©": { price: 90, time: 0.2, unit: "u" },
    "Feu clignotant orange": { price: 75, time: 0.1, unit: "u" },
    "Antenne d√©port√©e": { price: 45, time: 0.1, unit: "u" }
  },
  "üî• Chauffage & Ventilation": {
    "Radiateur √† inertie 1000W": { price: 390, time: 1, unit: "u" },
    "Radiateur √† inertie 2000W": { price: 550, time: 1.2, unit: "u" },
    "S√®che-serviette": { price: 450, time: 1, unit: "u" },
    "VMC simple flux": { price: 550, time: 2, unit: "u" },
    "VMC double flux": { price: 2900, time: 6, unit: "u" },
    "Extracteur ponctuel": { price: 130, time: 0.3, unit: "u" },
    "Bouche d'extraction": { price: 35, time: 0.05, unit: "u" }
  },
  "üîî S√©curit√© & Communication": {
    "Centrale Alarme": { price: 550, time: 1, unit: "u" },
    "Sir√®ne ext√©rieure": { price: 180, time: 0.2, unit: "u" },
    "D√©tecteur fum√©e": { price: 45, time: 0.1, unit: "u" },
    "Visiophone connect√©": { price: 490, time: 1, unit: "u" },
    "Interphone audio": { price: 260, time: 0.5, unit: "u" },
    "Cam√©ra IP ext√©rieure": { price: 350, time: 0.5, unit: "u" },
    "Baie de brassage": { price: 420, time: 1, unit: "u" }
  },
  "üß∞ Prestations & Main d'≈ìuvre": {
    "Heure de main d'≈ìuvre": { price: 55, time: 1, unit: "h" },
    "Forfait d√©placement": { price: 50, time: 0, unit: "u" },
    "Mise en conformit√© tableau": { price: 850, time: 3, unit: "u" },
    "Saign√©e dans b√©ton (ml)": { price: 40, time: 0.1, unit: "m" },
    "Recherche de panne": { price: 90, time: 1, unit: "u" },
    "Consuel (frais + dossier)": { price: 250, time: 0, unit: "u" }
  }
};
let database = JSON.parse(localStorage.getItem('zelio_full_v6')) || defaultDatabase;
let photos = JSON.parse(localStorage.getItem('zelio_photos')) || [];
let clients = JSON.parse(localStorage.getItem('zelio_clients')) || [];
let folders = JSON.parse(localStorage.getItem('zelio_folders')) || [];
let formData = JSON.parse(localStorage.getItem('zelio_formdata')) || {};

// --- NAVIGATION ---
function showPage(id, event) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  if(event) event.currentTarget.classList.add('active');
  if(id === 'clients') renderClients();
  if(id === 'export') document.getElementById('import-file').value = '';
  if(id === 'folders') renderFolders();
}

// --- ACCORD√âON ---
function toggleAccordion(header) { header.parentElement.classList.toggle('open'); }
function toggleAll(show) { document.querySelectorAll('.accordion-item').forEach(item => show ? item.classList.add('open') : item.classList.remove('open')); }
function resetQuantities() { if(confirm("R√©initialiser toutes les quantit√©s √† 0 ?")) { document.querySelectorAll('.qty-in').forEach(s => s.value = 0); calculate(); saveFormData(); showToast("Panier vid√© !"); } }
function fullReset() { if(confirm("Voulez-vous supprimer tous vos prix personnalis√©s et revenir √† la liste d'origine ?")) { localStorage.clear(); location.reload(); } }

// --- CLIENTS ---
function saveClient() {
  const c = {
    name: document.getElementById('c-name').value.trim(),
    phone: document.getElementById('c-phone').value.trim(),
    email: document.getElementById('c-email').value.trim(),
    addr: document.getElementById('c-addr').value.trim(),
    site: document.getElementById('c-site').value.trim(),
    type: document.getElementById('c-type').value.trim(),
    notes: document.getElementById('c-notes').value.trim()
  };
  if(!c.name) return showToast("Nom du client obligatoire !", "#ef4444");
  if(c.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(c.email)) return showToast("Email invalide !", "#ef4444");
  if(c.phone && !/^0[1-9]([-. ]?[0-9]{2}){4}$/.test(c.phone)) return showToast("T√©l√©phone invalide !", "#ef4444");
  if(clients.find(cl => cl.name === c.name)) {
    if(!confirm("Ce client existe d√©j√†. √âcraser ?")) return;
    clients = clients.filter(cl => cl.name !== c.name);
  }
  clients.push(c);
  localStorage.setItem('zelio_clients', JSON.stringify(clients));
  renderClientSelect();
  showToast("Client enregistr√© !");
}
function renderClientSelect() {
  const sel = document.getElementById('client-select');
  sel.innerHTML = `<option value="">-- Nouveau client --</option>`;
  clients.forEach((c,i) => {
    sel.innerHTML += `<option value="${i}">${c.name}</option>`;
  });
}
document.getElementById('client-select').addEventListener('change', function() {
  const idx = this.value;
  if(idx === "") {
    document.getElementById('c-name').value = "";
    document.getElementById('c-phone').value = "";
    document.getElementById('c-email').value = "";
    document.getElementById('c-addr').value = "";
    document.getElementById('c-site').value = "";
    document.getElementById('c-type').value = "";
    document.getElementById('c-notes').value = "";
    saveFormData();
    return;
  }
  const c = clients[idx];
  document.getElementById('c-name').value = c.name;
  document.getElementById('c-phone').value = c.phone;
  document.getElementById('c-email').value = c.email;
  document.getElementById('c-addr').value = c.addr;
  document.getElementById('c-site').value = c.site;
  document.getElementById('c-type').value = c.type;
  document.getElementById('c-notes').value = c.notes;
  saveFormData();
});
function renderClients() {
  const clDiv = document.getElementById('clients-list');
  clDiv.innerHTML = '';
  if(!clients.length) { clDiv.innerHTML = "<p style='color:#888;'>Aucun client enregistr√©.</p>"; return; }
  clients.forEach((c, i) => {
    clDiv.innerHTML += `
      <div class="item">
        <label><b>${c.name}</b> - ${c.phone} - ${c.email}</label>
        <button class="btn-small btn-danger" onclick="deleteClient(${i})">Supprimer</button>
      </div>
    `;
  });
}
function deleteClient(idx) {
  if(confirm("Supprimer ce client ?")) {
    clients.splice(idx,1);
    localStorage.setItem('zelio_clients', JSON.stringify(clients));
    renderClients();
    renderClientSelect();
    showToast("Client supprim√© !");
  }
}

// --- PHOTOS (compression avant stockage, max 10 photos) ---
document.getElementById('site-photos').addEventListener('change', function(e) {
  const files = Array.from(e.target.files);
  if(photos.length + files.length > 10) {
    showToast("Maximum 10 photos par dossier !", "#ef4444");
    return;
  }
  files.forEach(file => compressAndStorePhoto(file));
  e.target.value = '';
});
function compressAndStorePhoto(file) {
  const reader = new FileReader();
  reader.onload = function(evt) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      const maxW = 800;
      const scale = Math.min(1, maxW / img.width);
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
      photos.push(dataUrl);
      localStorage.setItem('zelio_photos', JSON.stringify(photos));
      showPhotoPreview();
    };
    img.src = evt.target.result;
  };
  reader.readAsDataURL(file);
}
function showPhotoPreview() {
  const preview = document.getElementById('photo-preview');
  preview.innerHTML = '';
  photos.forEach((src, idx) => {
    preview.innerHTML += `
      <div style="position:relative;">
        <img src="${src}" style="width:90px; height:90px; object-fit:cover; border-radius:8px; border:1px solid #ccc;">
        <button onclick="removePhoto(${idx})" style="position:absolute;top:2px;right:2px;background:#ef4444;color:white;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer;">√ó</button>
      </div>
    `;
  });
}
function removePhoto(idx) {
  photos.splice(idx, 1);
  localStorage.setItem('zelio_photos', JSON.stringify(photos));
  showPhotoPreview();
  showToast("Photo supprim√©e !");
}
showPhotoPreview();

// --- PRENDRE UNE PHOTO DIRECTEMENT ---
function takePhoto() {
  const video = document.getElementById('camera-stream');
  const captureBtn = document.getElementById('capture-btn');
  video.style.display = 'block';
  captureBtn.style.display = 'inline-block';
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => {
      video.srcObject = stream;
      captureBtn.onclick = function() {
        const canvas = document.getElementById('photo-canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
        if(photos.length >= 10) {
          showToast("Maximum 10 photos par dossier !", "#ef4444");
        } else {
          photos.push(dataUrl);
          localStorage.setItem('zelio_photos', JSON.stringify(photos));
          showPhotoPreview();
          showToast("Photo ajout√©e !");
        }
        stream.getTracks().forEach(track => track.stop());
        video.style.display = 'none';
        captureBtn.style.display = 'none';
      };
    })
    .catch(() => {
      showToast("Impossible d'acc√©der √† la cam√©ra.", "#ef4444");
      video.style.display = 'none';
      captureBtn.style.display = 'none';
    });
}

// --- RENDU DYNAMIQUE ---
function render() {
  const configA = document.getElementById('config-accordion');
  const pricesA = document.getElementById('prices-accordion');
  configA.innerHTML = ''; pricesA.innerHTML = '';
  for (const [cat, prods] of Object.entries(database)) {
    const catId = cat.replace(/[^\w]/g, '');
    configA.innerHTML += `<div class="accordion-item"><button class="accordion-header" onclick="toggleAccordion(this)">${cat}</button><div class="accordion-content"><div class="grid-items" id="c-${catId}"></div></div></div>`;
    pricesA.innerHTML += `<div class="accordion-item"><button class="accordion-header" onclick="toggleAccordion(this)">Modifier Tarifs : ${cat}</button><div class="accordion-content"><div class="grid-items" id="p-${catId}"></div></div></div>`;
    for (const [name, obj] of Object.entries(prods)) {
      document.getElementById(`c-${catId}`).innerHTML += `
        <div class="item">
          <label>${name} <span style="color:#64748b;font-size:0.8em;">(${obj.unit})</span> <span style="color:#64748b;font-size:0.8em;">${obj.time}h</span></label>
          <select class="qty-in" data-cat="${cat}" data-prod="${name}">${Array.from({length:101},(_,i)=>`<option value="${i}">${i}</option>`).join('')}</select>
        </div>`;
      document.getElementById(`p-${catId}`).innerHTML += `
        <div class="item">
          <label>${name} <span style="color:#64748b;font-size:0.8em;">(${obj.unit})</span> <span style="color:#64748b;font-size:0.8em;">${obj.time}h</span></label>
          <input type="number" value="${obj.price}" class="price-in" data-cat="${cat}" data-prod="${name}">
          <input type="number" value="${obj.time}" step="0.01" class="time-in" data-cat="${cat}" data-prod="${name}" style="width:60px;" title="Dur√©e estim√©e (h)">
        </div>`;
    }
  }
  document.querySelectorAll('.qty-in, .price-in, .time-in').forEach(el => el.addEventListener('input', function() {
    calculate();
    saveFormData();
  }));
  // Recharge les quantit√©s sauvegard√©es
  if(formData.quantities) {
    document.querySelectorAll('.qty-in').forEach(s => {
      const key = s.dataset.cat + '||' + s.dataset.prod;
      if(formData.quantities[key] !== undefined) s.value = formData.quantities[key];
    });
  }
}
render();

// --- CALCULS ---
function calculate() {
  let total = 0, totalTime = 0;
  document.querySelectorAll('.price-in').forEach(i => { 
    database[i.dataset.cat][i.dataset.prod].price = parseFloat(i.value) || 0; 
  });
  document.querySelectorAll('.time-in').forEach(i => { 
    database[i.dataset.cat][i.dataset.prod].time = parseFloat(i.value) || 0; 
  });
  localStorage.setItem('zelio_full_v6', JSON.stringify(database));
  document.querySelectorAll('.qty-in').forEach(s => { 
    const q = parseInt(s.value);
    const obj = database[s.dataset.cat][s.dataset.prod];
    total += q * obj.price;
    totalTime += q * obj.time;
  });
  document.getElementById('grand-total').innerText = total.toLocaleString();
  document.getElementById('grand-time').innerText = totalTime.toFixed(2);
}
calculate();

// --- SAUVEGARDE AUTOMATIQUE DES FORMULAIRES ---
function saveFormData() {
  formData = {
    c_name: document.getElementById('c-name').value,
    c_phone: document.getElementById('c-phone').value,
    c_email: document.getElementById('c-email').value,
    c_addr: document.getElementById('c-addr').value,
    c_site: document.getElementById('c-site').value,
    c_type: document.getElementById('c-type').value,
    c_notes: document.getElementById('c-notes').value,
    my_name: document.getElementById('my-name').value,
    my_siret: document.getElementById('my-siret').value,
    my_addr: document.getElementById('my-addr').value,
    my_ins: document.getElementById('my-ins').value,
    quantities: {}
  };
  document.querySelectorAll('.qty-in').forEach(s => {
    const key = s.dataset.cat + '||' + s.dataset.prod;
    formData.quantities[key] = s.value;
  });
  localStorage.setItem('zelio_formdata', JSON.stringify(formData));
}
function loadFormData() {
  if(!formData) return;
  document.getElementById('c-name').value = formData.c_name || "";
  document.getElementById('c-phone').value = formData.c_phone || "";
  document.getElementById('c-email').value = formData.c_email || "";
  document.getElementById('c-addr').value = formData.c_addr || "";
  document.getElementById('c-site').value = formData.c_site || "";
  document.getElementById('c-type').value = formData.c_type || "";
  document.getElementById('c-notes').value = formData.c_notes || "";
  document.getElementById('my-name').value = formData.my_name || "";
  document.getElementById('my-siret').value = formData.my_siret || "";
  document.getElementById('my-addr').value = formData.my_addr || "";
  document.getElementById('my-ins').value = formData.my_ins || "";
  // Les quantit√©s sont recharg√©es dans render()
}
loadFormData();
document.querySelectorAll('#c-name,#c-phone,#c-email,#c-addr,#c-site,#c-type,#c-notes,#my-name,#my-siret,#my-addr,#my-ins').forEach(el => {
  el.addEventListener('input', function() { saveFormData(); });
});

// --- PDF DEVIS (corrig√©, plus de page blanche) ---
function generatePDF() {
  saveFolder();
  const c = getClientData();
  const m = getArtisanData();
  let rows = "", totalTime = 0;
  document.querySelectorAll('.qty-in').forEach(s => {
    const q = parseInt(s.value);
    if(q > 0) {
      const obj = database[s.dataset.cat][s.dataset.prod];
      rows += `<tr><td style="padding:10px; border-bottom:1px solid #eee;">${s.dataset.prod} <span style='color:#64748b;font-size:0.8em;'>(${obj.unit})</span></td><td style="text-align:center; border-bottom:1px solid #eee;">${q}</td><td style="text-align:right; border-bottom:1px solid #eee;">${obj.price}‚Ç¨</td><td style="text-align:right; border-bottom:1px solid #eee;">${q*obj.price}‚Ç¨</td></tr>`;
      totalTime += q * obj.time;
    }
  });
  if(!rows) return showToast("Le devis est vide !", "#ef4444");
  const element = document.createElement('div');
  element.style.padding = "40px";
  element.style.fontFamily = "sans-serif";
  element.innerHTML = `
    <div style="display:flex; justify-content:space-between; border-bottom:3px solid #4f46e5; padding-bottom:15px; margin-bottom:25px;">
        <div><h1 style="color:#4f46e5; margin:0;">${m.name || 'DEVIS √âLECTRIQUE'}</h1><p style="font-size:12px; margin-top:5px;">SIRET: ${m.siret}<br>${m.addr}</p></div>
        <div style="text-align:right;"><h2>DEVIS N¬∞ ${Math.floor(Math.random()*1000)}</h2><p>Date: ${new Date().toLocaleDateString()}</p></div>
    </div>
    <div style="display:flex; justify-content:space-between; margin-bottom:35px; font-size:14px;">
        <div style="width:48%; background:#f8fafc; padding:20px; border-radius:10px;">
            <strong style="color:#4f46e5;">CLIENT :</strong><br>${c.name}<br>${c.addr}<br>T√©l: ${c.phone}<br>${c.email}
        </div>
        <div style="width:48%; border:1px solid #e2e8f0; padding:20px; border-radius:10px;">
            <strong style="color:#4f46e5;">D√âTAILS CHANTIER :</strong><br>Type: ${c.type}<br>Lieu: ${c.site || c.addr}
        </div>
    </div>
    <h2 style="color:#4f46e5; margin-top:30px;">Notes du Chantier</h2>
    <p style="background:#f8fafc; padding:10px; border-radius:8px; color:#333;">${c.notes || "Aucune note."}</p>
    <table style="width:100%; border-collapse:collapse; font-size:13px; margin-top:20px;">
        <tr style="background:#4f46e5; color:white;">
            <th style="padding:12px; text-align:left;">D√©signation</th><th style="padding:12px;">Qt√©</th><th style="padding:12px; text-align:right;">PU HT</th><th style="padding:12px; text-align:right;">Total HT</th>
        </tr>
        ${rows}
    </table>
    <div style="text-align:right; margin-top:40px;">
        <p style="margin:5px 0;">Total HT : ${document.getElementById('grand-total').innerText} ‚Ç¨</p>
        <p style="margin:5px 0;">TVA (20%) : ${(parseFloat(document.getElementById('grand-total').innerText.replace(/\s/g,''))*0.2).toFixed(2)} ‚Ç¨</p>
        <h2 style="color:#4f46e5; margin-top:10px;">TOTAL TTC : ${(parseFloat(document.getElementById('grand-total').innerText.replace(/\s/g,''))*1.2).toFixed(2)} ‚Ç¨</h2>
        <p style="margin:5px 0;">Temps estim√© : ${totalTime.toFixed(2)} h</p>
    </div>
    <div style="margin-top:50px; font-size:11px; color:#666; border-top:1px solid #eee; padding-top:15px;">
        <p><strong>Conditions :</strong> Valable 30 jours. Assurance D√©cennale : ${m.ins}</p>
        <p style="margin-top:20px;">Bon pour accord le : ____ / ____ / 20____ &nbsp;&nbsp;&nbsp; Cachet et Signature :</p>
    </div>
  `;
  element.style.display = "none";
  document.body.appendChild(element);
  html2pdf().from(element).set({ margin: 0.5, filename: `Devis_ZELIO_${c.name.replace(/[^\w\d]/g,'_')}.pdf`, html2canvas: { scale: 2 } }).save().then(() => {
    document.body.removeChild(element);
    showToast("PDF g√©n√©r√© !");
  });
}

// --- PDF RAPPORT (corrig√©, plus de page blanche) ---
function generateReport() {
  saveFolder();
  const c = getClientData();
  const m = getArtisanData();
  let rows = "", totalTime = 0;
  document.querySelectorAll('.qty-in').forEach(s => {
    const q = parseInt(s.value);
    if(q > 0) {
      const obj = database[s.dataset.cat][s.dataset.prod];
      rows += `<tr><td style="padding:10px; border-bottom:1px solid #eee;">${s.dataset.prod} <span style='color:#64748b;font-size:0.8em;'>(${obj.unit})</span></td><td style="text-align:center; border-bottom:1px solid #eee;">${q}</td><td style="text-align:right; border-bottom:1px solid #eee;">${obj.price}‚Ç¨</td><td style="text-align:right; border-bottom:1px solid #eee;">${q*obj.price}‚Ç¨</td></tr>`;
      totalTime += q * obj.time;
    }
  });
  let photosHtml = "";
  if(photos.length) {
    photosHtml = `<div style="margin:20px 0; display:flex; flex-wrap:wrap; gap:10px;">` +
      photos.map(src => `<img src="${src}" style="width:180px; height:130px; object-fit:cover; border-radius:8px; border:1px solid #ccc;">`).join('') +
      `</div>`;
  }
  const element = document.createElement('div');
  element.style.padding = "40px";
  element.style.fontFamily = "sans-serif";
  element.innerHTML = `
    <div style="display:flex; justify-content:space-between; border-bottom:3px solid #4f46e5; padding-bottom:15px; margin-bottom:25px;">
        <div><h1 style="color:#4f46e5; margin:0;">${m.name || 'RAPPORT DE CHANTIER'}</h1><p style="font-size:12px; margin-top:5px;">SIRET: ${m.siret}<br>${m.addr}</p></div>
        <div style="text-align:right;"><h2>RAPPORT N¬∞ ${Math.floor(Math.random()*1000)}</h2><p>Date: ${new Date().toLocaleDateString()}</p></div>
    </div>
    <div style="display:flex; justify-content:space-between; margin-bottom:35px; font-size:14px;">
        <div style="width:48%; background:#f8fafc; padding:20px; border-radius:10px;">
            <strong style="color:#4f46e5;">CLIENT :</strong><br>${c.name}<br>${c.addr}<br>T√©l: ${c.phone}<br>${c.email}
        </div>
        <div style="width:48%; border:1px solid #e2e8f0; padding:20px; border-radius:10px;">
            <strong style="color:#4f46e5;">D√âTAILS CHANTIER :</strong><br>Type: ${c.type}<br>Lieu: ${c.site || c.addr}
        </div>
    </div>
    <h2 style="color:#4f46e5;">Photos du Chantier</h2>
    ${photosHtml || "<p style='color:#888;'>Aucune photo ajout√©e.</p>"}
    <h2 style="color:#4f46e5; margin-top:30px;">Notes du Chantier</h2>
    <p style="background:#f8fafc; padding:10px; border-radius:8px; color:#333;">${c.notes || "Aucune note."}</p>
    <h2 style="color:#4f46e5; margin-top:30px;">Liste des Prestations</h2>
    <table style="width:100%; border-collapse:collapse; font-size:13px;">
        <tr style="background:#4f46e5; color:white;">
            <th style="padding:12px; text-align:left;">D√©signation</th><th style="padding:12px;">Qt√©</th><th style="padding:12px; text-align:right;">PU HT</th><th style="padding:12px; text-align:right;">Total HT</th>
        </tr>
        ${rows || "<tr><td colspan='4' style='text-align:center; color:#888; padding:20px;'>Aucune prestation s√©lectionn√©e.</td></tr>"}
    </table>
    <div style="text-align:right; margin-top:40px;">
        <p style="margin:5px 0;">Total HT : ${document.getElementById('grand-total').innerText} ‚Ç¨</p>
        <p style="margin:5px 0;">TVA (20%) : ${(parseFloat(document.getElementById('grand-total').innerText.replace(/\s/g,''))*0.2).toFixed(2)} ‚Ç¨</p>
        <h2 style="color:#4f46e5; margin-top:10px;">TOTAL TTC : ${(parseFloat(document.getElementById('grand-total').innerText.replace(/\s/g,''))*1.2).toFixed(2)} ‚Ç¨</h2>
        <p style="margin:5px 0;">Temps estim√© : ${totalTime.toFixed(2)} h</p>
    </div>
    <div style="margin-top:50px; font-size:11px; color:#666; border-top:1px solid #eee; padding-top:15px;">
        <p><strong>Conditions :</strong> Valable 30 jours. Assurance D√©cennale : ${m.ins}</p>
        <p style="margin-top:20px;">Signature du client :</p>
    </div>
  `;
  element.style.display = "none";
  document.body.appendChild(element);
  html2pdf().from(element).set({ margin: 0.5, filename: `Rapport_ZELIO_${c.name.replace(/[^\w\d]/g,'_')}.pdf`, html2canvas: { scale: 2 } }).save().then(() => {
    document.body.removeChild(element);
    showToast("PDF g√©n√©r√© !");
  });
}

// --- DOSSIERS CLIENTS (SAUVEGARDE) ---
function saveFolder() {
  const c = getClientData();
  const m = getArtisanData();
  let quantities = {};
  document.querySelectorAll('.qty-in').forEach(s => {
    const key = s.dataset.cat + '||' + s.dataset.prod;
    quantities[key] = s.value;
  });
  const folder = {
    client: c,
    artisan: m,
    quantities,
    photos: [...photos],
    date: new Date().toISOString()
  };
  let idx = folders.findIndex(f => f.client.name === c.name && f.client.addr === c.addr);
  if(idx !== -1) folders[idx] = folder;
  else folders.push(folder);
  localStorage.setItem('zelio_folders', JSON.stringify(folders));
}
function renderFolders() {
  const fDiv = document.getElementById('folders-list');
  fDiv.innerHTML = '';
  if(!folders.length) { fDiv.innerHTML = "<p style='color:#888;'>Aucun dossier sauvegard√©.</p>"; return; }
  folders.forEach((f, i) => {
    fDiv.innerHTML += `
      <div class="item">
        <label><b>${f.client.name}</b> - ${f.client.addr} <span style="color:#64748b;font-size:0.8em;">(${new Date(f.date).toLocaleDateString()})</span></label>
        <button class="btn-small" onclick="loadFolder(${i})">Charger</button>
        <button class="btn-small btn-danger" onclick="deleteFolder(${i})">Supprimer</button>
      </div>
    `;
  });
}
function loadFolder(idx) {
  const f = folders[idx];
  document.getElementById('c-name').value = f.client.name;
  document.getElementById('c-phone').value = f.client.phone;
  document.getElementById('c-email').value = f.client.email;
  document.getElementById('c-addr').value = f.client.addr;
  document.getElementById('c-site').value = f.client.site;
  document.getElementById('c-type').value = f.client.type;
  document.getElementById('c-notes').value = f.client.notes;
  document.getElementById('my-name').value = f.artisan.name;
  document.getElementById('my-siret').value = f.artisan.siret;
  document.getElementById('my-addr').value = f.artisan.addr;
  document.getElementById('my-ins').value = f.artisan.ins;
  document.querySelectorAll('.qty-in').forEach(s => {
    const key = s.dataset.cat + '||' + s.dataset.prod;
    s.value = f.quantities[key] || 0;
  });
  photos = [...f.photos];
  localStorage.setItem('zelio_photos', JSON.stringify(photos));
  showPhotoPreview();
  calculate();
  saveFormData();
  showToast("Dossier charg√© !");
}
function deleteFolder(idx) {
  if(confirm("Supprimer ce dossier ?")) {
    folders.splice(idx,1);
    localStorage.setItem('zelio_folders', JSON.stringify(folders));
    renderFolders();
    showToast("Dossier supprim√© !");
  }
}

// --- OUTILS ---
function getClientData() {
  return {
    name: document.getElementById('c-name').value,
    phone: document.getElementById('c-phone').value,
    email: document.getElementById('c-email').value,
    addr: document.getElementById('c-addr').value,
    site: document.getElementById('c-site').value,
    type: document.getElementById('c-type').value,
    notes: document.getElementById('c-notes').value
  };
}
function getArtisanData() {
  return {
    name: document.getElementById('my-name').value,
    siret: document.getElementById('my-siret').value,
    addr: document.getElementById('my-addr').value,
    ins: document.getElementById('my-ins').value
  };
}

// --- EXPORT/IMPORT ---
function exportData() {
  const data = {
    database, photos, clients, folders, formData
  };
  const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = "zelio_backup.json";
  a.click();
  URL.revokeObjectURL(url);
  showToast("Export JSON OK !");
}
document.getElementById('import-file').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    try {
      const data = JSON.parse(evt.target.result);
      if(data.database) database = data.database;
      if(data.photos) photos = data.photos;
      if(data.clients) clients = data.clients;
      if(data.folders) folders = data.folders;
      if(data.formData) formData = data.formData;
      localStorage.setItem('zelio_full_v6', JSON.stringify(database));
      localStorage.setItem('zelio_photos', JSON.stringify(photos));
      localStorage.setItem('zelio_clients', JSON.stringify(clients));
      localStorage.setItem('zelio_folders', JSON.stringify(folders));
      localStorage.setItem('zelio_formdata', JSON.stringify(formData));
      showToast("Importation r√©ussie !");
      location.reload();
    } catch(e) { showToast("Fichier invalide.", "#ef4444"); }
  };
  reader.readAsText(file);
});

// --- INIT ---
renderClientSelect();
showPhotoPreview();
</script>
</body>
</html>
